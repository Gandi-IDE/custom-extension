const witcat_more_mouse_picture = "data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSI0NzkuMzg5MDciIGhlaWdodD0iMzU5LjU4OTg0IiB2aWV3Qm94PSIwLDAsNDc5LjM4OTA3LDM1OS41ODk4NCI+PGRlZnM+PGxpbmVhckdyYWRpZW50IHgxPSIyNDAuMDAwMDMiIHkxPSIwLjM2NDIxIiB4Mj0iMjQwLjAwMDAzIiB5Mj0iMzU5LjYzNTgzIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgaWQ9ImNvbG9yLTEiPjxzdG9wIG9mZnNldD0iMCIgc3RvcC1jb2xvcj0iIzhlYWNlMSIvPjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzg5YTdkYSIvPjwvbGluZWFyR3JhZGllbnQ+PGxpbmVhckdyYWRpZW50IHgxPSIyNDYuNzM1MTkiIHkxPSIxMTguMDc2NSIgeDI9IjI0OC4yNzY2OCIgeTI9IjIyMC45OTIxNCIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIGlkPSJjb2xvci0yIj48c3RvcCBvZmZzZXQ9IjAiIHN0b3AtY29sb3I9IiNmZmZmZmYiLz48c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiNlNWVhZjMiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC4zMDU0OSwtMC4zNjQyMSkiPjxnIGRhdGEtcGFwZXItZGF0YT0ieyZxdW90O2lzUGFpbnRpbmdMYXllciZxdW90Ozp0cnVlfSIgZmlsbC1ydWxlPSJub256ZXJvIiBzdHJva2Utd2lkdGg9IjAiIHN0cm9rZS1saW5lam9pbj0ibWl0ZXIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgc3Ryb2tlLWRhc2hhcnJheT0iIiBzdHJva2UtZGFzaG9mZnNldD0iMCIgc3R5bGU9Im1peC1ibGVuZC1tb2RlOiBub3JtYWwiPjxwYXRoIGQ9Ik0wLjMwNTQ5LDM1OS42MzU4M3YtMzU5LjI3MTYyaDQ3OS4zODkwN3YzNTkuMjcxNjJ6IiBmaWxsPSJ1cmwoI2NvbG9yLTEpIiBzdHJva2U9Im5vbmUiIHN0cm9rZS1saW5lY2FwPSJidXR0Ii8+PHBhdGggZD0iTTIwMC45OTA5NiwzNTkuMzM3MDlsMTAuMjI3NzYsLTI0MC4xNDk0OGwxOTMuMDc4NTQsMjQwLjc2NjQ0eiIgZmlsbD0iIzcyOGJiNSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48cGF0aCBkPSJNMjQ3LjA3OTk5LDIyMS4wMTAwNmwtMTIuNDI0LC0zMC4zMzY0M2wtMjAuMDM5MDcsMjAuNjQ4NWwtMS4zODkxNCwtOTIuNzQzNzNsNjguMDE4NTksNjYuMDExMDZsLTI5LjMxODk4LDAuNDM5MTVsMTEuMDk3NTIsMjkuNjk3NDN6IiBmaWxsPSJ1cmwoI2NvbG9yLTIpIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjwvZz48L2c+PC9zdmc+PCEtLXJvdGF0aW9uQ2VudGVyOjIzOS42OTQ1MDYzMjc4NzM5OjE3OS42MzU3OTEwMDI3Mjk3Ny0tPg==";

const witcat_more_mouse_icon = "data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSIxNzcuMDg4NTUiIGhlaWdodD0iMTc3LjA4ODU1IiB2aWV3Qm94PSIwLDAsMTc3LjA4ODU1LDE3Ny4wODg1NSI+PGRlZnM+PGxpbmVhckdyYWRpZW50IHgxPSIyNDcuMDc3MyIgeTE9IjExOS4xNDIzMSIgeDI9IjI0Ny4wNzczIiB5Mj0iMjIyLjA2OTQ4IiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgaWQ9ImNvbG9yLTEiPjxzdG9wIG9mZnNldD0iMCIgc3RvcC1jb2xvcj0iI2ZmZmZmZiIvPjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iI2U1ZWFmMyIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0xNTEuNDU1NzYsLTkxLjQ1NTc0KSI+PGcgZGF0YS1wYXBlci1kYXRhPSJ7JnF1b3Q7aXNQYWludGluZ0xheWVyJnF1b3Q7OnRydWV9IiBmaWxsLXJ1bGU9Im5vbnplcm8iIHN0cm9rZS13aWR0aD0iMCIgc3Ryb2tlLWxpbmVqb2luPSJtaXRlciIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBzdHJva2UtZGFzaGFycmF5PSIiIHN0cm9rZS1kYXNob2Zmc2V0PSIwIiBzdHlsZT0ibWl4LWJsZW5kLW1vZGU6IG5vcm1hbCI+PHBhdGggZD0iTTE1MS40NTU3NiwyNjguNTQ0Mjl2LTE3Ny4wODg1NWgxNzcuMDg4NTV2MTc3LjA4ODU1eiIgZmlsbD0iIzhlYWNlMSIgc3Ryb2tlPSJub25lIiBzdHJva2UtbGluZWNhcD0iYnV0dCIvPjxwYXRoIGQ9Ik0yMzguMjAwNywyNDAuODU3NjlsLTEwLjQ4NDQxLC0zNS4xNjgwMmwtMjEuMzAyNDQsMjEuOTAwNjJsNC40Njc1OCwtMTA0Ljg5OTUxbDYzLjcxNjM3LDc5LjQ1MzQ5bC0yOS4yODgyNCwtMS41OTkxMmw5LjIwMDkxLDM0LjM1MTE1eiIgZmlsbD0iIzcyOGJiNSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48cGF0aCBkPSJNMjQ1Ljg4MDQ3LDIyMi4wNjk0OGwtMTEuOTY4MjcsLTMwLjUxOTFsLTIwLjM0NjA3LDIwLjM0NjA3di05Mi43NTQxM2w2Ny4wMjIzNCw2Ny4wMjIzNGgtMjkuMzIyMjdsMTAuNjUxNTEsMjkuODYwM3oiIGZpbGw9InVybCgjY29sb3ItMSkiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PC9nPjwvZz48L3N2Zz48IS0tcm90YXRpb25DZW50ZXI6ODguNTQ0MjQ0OTk5OTk5OTk6ODguNTQ0MjU1LS0+";

const witcat_more_mouse_extensionId = 'WitCatMouse';

/** @typedef {string|number} SCarg æ¥è‡ªScratchåœ†å½¢æ¡†çš„å‚æ•°ï¼Œè™½ç„¶è¿™ä¸ªæ¡†å¯èƒ½åªèƒ½è¾“å…¥æ•°å­—ï¼Œä½†æ˜¯å¯ä»¥æ”¾å…¥å˜é‡ï¼Œå› æ­¤æœ‰å¯èƒ½è·å¾—æ•°å­—å’Œæ–‡æœ¬ï¼Œéœ€è¦åŒæ—¶å¤„ç† */

class WitCatMouse {
	constructor(runtime) {
		/**
		 * é¼ æ ‡é”®æ˜¯å¦æŒ‰ä¸‹
		 * @type {("up"|"down")[]}
		 */
		this.button = ['up', 'up', 'up', 'up', 'up'];

		/**
		 * é¼ æ ‡xç§»åŠ¨é€Ÿåº¦
		 */
		this.xMouse = 0;

		/**
		 * é¼ æ ‡yç§»åŠ¨é€Ÿåº¦
		 */
		this.yMouse = 0;
		/**
		* é¼ æ ‡x
		*/
		this.MouseX = 0;

		/**
		 * é¼ æ ‡y
		 */
		this.MouseY = 0;

		/**
		 * é¼ æ ‡æ»šè½®é€Ÿåº¦
		 */
		this.MouseWheel = 0;

		/**
		 * ä¸Šæ¬¡è®¾ç½®åˆ†è¾¨ç‡çš„æ—¶é—´
		 */
		this.LastSet = 0;

		/**
		 * é¼ æ ‡é€Ÿåº¦é‡ç½®è®¡æ—¶å™¨
		 * @type {null|number}
		 */
		this.timer = null;

		/**
		 * è§¦å±é€Ÿåº¦é‡ç½®è®¡æ—¶å™¨
		 */
		this.touchtimer = null;

		/**
		 * æ‰‹æŒ‡åˆ—è¡¨
		 * @type {{identifier: number|"mouse", clientX: number, clientY: number}[]}
		 */
		this.touch = [];

		/**
		 * ç‚¹å‡»äº‹ä»¶è®¡æ—¶å™¨
		 * @type {false|number}
		 */
		this.click = false;

		/**
		 * åŒå‡»äº‹ä»¶è®¡æ—¶å™¨
		 * @type {false|number}
		 */
		this.dclick = false;

		/**
		 * é¼ æ ‡æŒ‰ä¸‹è®¡æ—¶å™¨(è®°å½•æŒ‰ä¸‹é¼ æ ‡çš„æ—¶åˆ»)
		 * @type {(""|number)[]}
		 */
		this.mousetdlist = ['', '', '', '', ''];

		/**
		 * è·å–çš„æ‰‹æœºè§’åº¦ä¿¡æ¯
		 */
		this.Gyroscope = {};

		/**
		 * é¼ æ ‡æç¤ºçš„å¾ªç¯å¤„ç†
		 */
		this.MouseTitle = null;

		/**
		 * é¼ æ ‡æç¤ºçš„div
		 * @type {HTMLDivElement}
		 */
		this.titleDiv = null;

		this.runtime = runtime;

		/**
		 * Scratch æ‰€ä½¿ç”¨çš„ canvasï¼Œè·å–ä¸åˆ°è¿”å› null
		 * @return {HTMLCanvasElement | null}
		 */
		this.canvas = () => {
			try {
				const { canvas } = this.runtime.renderer;
				if (canvas instanceof HTMLCanvasElement) {
					return canvas.parentElement;
				}
				return null;
			} catch (err) {
				return null;
			}
		};

		this.canvasSelf = () => {
			try {
				const { canvas } = this.runtime.renderer;
				if (canvas instanceof HTMLCanvasElement) {
					return canvas;
				}
				return null;
			} catch (err) {
				return null;
			}
		};

		if (this.canvas() === null) {
			console.error('å½“å‰é¡µé¢ä¸æ”¯æŒå¤šæŒ‡è§¦æ§/å…¨å±ï¼Œè¯·å‰å¾€ä½œå“è¯¦æƒ…é¡µä½“éªŒå®Œæ•´ä½œå“ï¼');
			// æ³¨æ„ï¼šåœ¨æç¤ºä¹‹åï¼Œæ‰©å±•ä»ç„¶åœ¨è¿è¡Œã€‚éœ€è¦åœ¨åé¢å¼•ç”¨ Canvas çš„éƒ¨åˆ†è¿›è¡Œåˆ¤æ–­ã€‚
		}
		this._addevent();

		this._formatMessage = runtime.getFormatMessage({
			'zh-cn': {
				'WitCatMouse.copythis': 'å¤åˆ¶ä»¥ä¸‹å†…å®¹ï¼š',
				'WitCatMouse.name': 'ç™½çŒ«çš„é«˜çº§é¼ æ ‡',
				'WitCatMouse.name.1': 'é«˜çº§é¼ æ ‡',
				'WitCatMouse.name.2': 'æ‰‹æœºç«¯',
				'WitCatMouse.set': '[set]å³é”®èœå•',
				'WitCatMouse.set.1': 'å¯ç”¨',
				'WitCatMouse.set.2': 'ç¦ç”¨',
				'WitCatMouse.when': 'é¼ æ ‡[key]è¢«æŒ‰ä¸‹',
				'WitCatMouse.key.1': 'å·¦é”®',
				'WitCatMouse.key.2': 'ä¸­é”®',
				'WitCatMouse.key.3': 'å³é”®',
				'WitCatMouse.key.4': 'å‰ä¾§é”®',
				'WitCatMouse.key.5': 'åä¾§é”®',
				'WitCatMouse.mouseuse': '[mouseuse]é¼ æ ‡',
				'WitCatMouse.mouseuse.1': 'é”å®š',
				'WitCatMouse.mouseuse.2': 'é‡Šæ”¾',
				'WitCatMouse.acceleration': 'é¼ æ ‡[way]é€Ÿåº¦', // é€Ÿåº¦å’ŒåŠ é€Ÿåº¦çš„åŒºåˆ«
				'WitCatMouse.way.1': 'X',
				'WitCatMouse.way.2': 'Y',
				'WitCatMouse.way.3': 'Z',
				'WitCatMouse.way.4': 'è·ç¦»',
				'WitCatTouch.down': 'æŒ‰ä¸‹çš„æ‰‹æŒ‡æ•°é‡',
				'WitCatTouch.istouch': 'ç¢°åˆ°æ‰‹æŒ‡[num]?',
				'WitCatTouch.touchs': 'ç¢°åˆ°çš„æ‰‹æŒ‡',
				'WitCatTouch.num': 'ç¬¬[num]ä¸ªæ‰‹æŒ‡çš„[type]',
				'WitCatTouch.info': 'æ‰‹æŒ‡[num]çš„[type]',
				'WitCatMouse.touchacceleration': 'æ‰‹æŒ‡[num]çš„[way]é€Ÿåº¦',
				'WitCatTouch.type.1': 'X',
				'WitCatTouch.type.2': 'Y',
				'WitCatTouch.type.3': 'ID',
				'WitCatTouch.type.4': 'æŒ‰ä¸‹?',
				'WitCatMouse.fill': '[set]æ²‰æµ¸å¼å…¨å±',
				'WitCatMouse.whenoutfill': 'å½“é€€å‡ºå…¨å±',
				'WitCatMouse.isfill': 'å…¨å±?',
				'WitCatMouse.fillask.1': 'ä½œå“è¯·æ±‚æ²‰æµ¸å¼å…¨å±ï¼Œæ˜¯å¦åŒæ„ï¼Ÿ\n',
				'WitCatMouse.fillask.2': '/3æ¬¡è¿ç»­æ‹’ç»åå°†ä¸å†æç¤º\næ‚¨ä»å¯ä»¥ä½¿ç”¨ esc åˆ‡æ¢æ²‰æµ¸å¼å…¨å±çŠ¶æ€',
				'WitCatMouse.setfill': 'âš ï¸(å±)è®¾ç½®åˆ†è¾¨ç‡é«˜è®¾ä¸º[num]',
				'WitCatMouse.resolution': 'å½“å‰åˆ†è¾¨ç‡é«˜',
				'WitCatMouse.cantouch': 'è®¾å¤‡æ”¯æŒ[type]?',
				'WitCatMouse.types.1': 'è§¦å±',
				'WitCatMouse.types.2': 'é¼ æ ‡',
				'WitCatMouse.IsMobile': 'ç§»åŠ¨è®¾å¤‡?',
				'WitCatMouse.cursor': 'æ›´æ”¹é¼ æ ‡çš„æ ·å¼ä¸º[cursor]',
				'WitCatMouse.cursor.1': 'é»˜è®¤',
				'WitCatMouse.cursor.2': 'æ–‡æœ¬',
				'WitCatMouse.cursor.3': 'åå­—ç§»åŠ¨',
				'WitCatMouse.cursor.4': 'ä¸Šä¸‹ç§»åŠ¨',
				'WitCatMouse.cursor.5': 'å·¦å³ç§»åŠ¨',
				'WitCatMouse.cursor.6': 'ç¦æ­¢',
				'WitCatMouse.cursor.7': 'æ‰‹æŒ‡',
				'WitCatMouse.cursor.8': 'åŠ è½½',
				'WitCatMouse.cursor.9': 'ç­‰å¾…',
				'WitCatMouse.cursor.10': 'å¸®åŠ©',
				'WitCatMouse.cursor.11': 'ç«–å‘æ–‡æœ¬',
				'WitCatMouse.cursor.12': 'åå­—å‡†æ˜Ÿ',
				'WitCatMouse.cursorurl': 'æ›´æ”¹é¼ æ ‡çš„æ ·å¼ä¸ºX[x]Y[y]data url[text]',
				'WitCatMouse.cursorstyle': 'æ›´æ”¹é¼ æ ‡çš„æ ·å¼ä¸ºX[x]Y[y]å¤§å°[size]è§’è‰²[s]çš„ç¬¬[shape]é€ å‹',
				'WitCatMouse.url': 'ä¸Šä¼ icoå¹¶è·å¾—data url',
				'WitCatMouse.click': 'ç‚¹å‡»',
				'WitCatMouse.dclick': 'åŒå‡»',
				'WitCatMouse.mouse': 'é¼ æ ‡è¢«[way]?',
				'WitCatMouse.mousetd': 'å½“é¼ æ ‡[key]æŒ‰ä½[time]ç§’',
				'WitCatMouse.mouset': 'é¼ æ ‡[key]æŒ‰ä¸‹æ—¶é•¿(ç§’)',
				'WitCatMouse.docs': 'ğŸ“–æ‹“å±•æ•™ç¨‹',
				'WitCatMouse.mousewheel': 'é¼ æ ‡æ»šè½®é€Ÿåº¦',
				'WitCatMouse.gyroscope': 'å½“å‰[p]è½´è§’åº¦',
				'WitCatMouse.title': 'è®¾ç½®é¼ æ ‡æç¤º[text]',
				'WitCatMouse.titlenow': '[show]é¼ æ ‡æç¤º[text]',
				'WitCatMouse.show.1': 'æ˜¾ç¤º',
				'WitCatMouse.show.2': 'éšè—',
			},
			en: {
				'WitCatMouse.copythis': 'Copy the following text:',
				'WitCatMouse.name': 'WitCatâ€™s Mouse',
				'WitCatMouse.name.1': 'more mouse',
				'WitCatMouse.name.2': 'Mobile terminal',
				'WitCatMouse.set': '[set]right-click menu',
				'WitCatMouse.set.1': 'Enable',
				'WitCatMouse.set.2': 'Disable',
				'WitCatMouse.when': 'mouse[key]down?',
				'WitCatMouse.key.1': 'left button',
				'WitCatMouse.key.2': 'middle button',
				'WitCatMouse.key.3': 'right button',
				'WitCatMouse.key.4': 'first side button',
				'WitCatMouse.key.5': 'second side button',
				'WitCatMouse.mouseuse': '[mouseuse]mouse',
				'WitCatMouse.mouseuse.1': 'Lock',
				'WitCatMouse.mouseuse.2': 'Release',
				'WitCatMouse.acceleration': 'mouse[way]speed',
				'WitCatMouse.way.1': 'X',
				'WitCatMouse.way.2': 'Y',
				'WitCatMouse.way.3': 'Z',
				'WitCatMouse.way.4': 'distance',
				'WitCatTouch.name': 'Touch',
				'WitCatTouch.down': 'Finger count',
				'WitCatTouch.istouch': 'Touch finger[num]?',
				'WitCatTouch.touchs': 'Touching fingers',
				'WitCatTouch.num': '[type]of finger[num]',
				'WitCatTouch.info': '[type] of finger [num]',
				'WitCatMouse.touchacceleration': '[way]speed of[num]finger',
				'WitCatTouch.type.1': 'X',
				'WitCatTouch.type.2': 'Y',
				'WitCatTouch.type.3': 'ID',
				'WitCatTouch.type.4': 'press?',
				'WitCatMouse.fill': '[set]immersive full-screen',
				'WitCatMouse.whenoutfill': 'When exiting full screen',
				'WitCatMouse.isfill': 'full screen?',
				'WitCatMouse.fillask.1':
					'The project requests to turn on immersive full-screen, agree or not?\nWill stop asking if you keep on to reject for ',
				'WitCatMouse.fillask.2': '/3 times\nYou can also use esc to toggle immersive full-screen later.',
				'WitCatMouse.setfill': 'âš ï¸(danger)Set resolution height to[num]',
				'WitCatMouse.resolution': 'Current high resolution',
				'WitCatMouse.cantouch': 'Device support[type]?',
				'WitCatMouse.types.1': 'touch screen',
				'WitCatMouse.types.2': 'mouse',
				'WitCatMouse.IsMobile': 'Mobile device?',
				'WitCatMouse.cursor': 'Change cursor style to[cursor]',
				'WitCatMouse.cursor.1': 'default',
				'WitCatMouse.cursor.2': 'text',
				'WitCatMouse.cursor.3': 'cross move',
				'WitCatMouse.cursor.4': 'move up and down',
				'WitCatMouse.cursor.5': 'move left and right',
				'WitCatMouse.cursor.6': 'not allowed',
				'WitCatMouse.cursor.7': 'pointer',
				'WitCatMouse.cursor.8': 'progress',
				'WitCatMouse.cursor.9': 'wait',
				'WitCatMouse.cursor.10': 'help',
				'WitCatMouse.cursor.11': 'vertical text',
				'WitCatMouse.cursor.12': 'crosshair',
				'WitCatMouse.cursorurl': 'Change the style of the mouse to X[x]Y[y]base64[text]',
				'WitCatMouse.cursorstyle': 'Change the mouse style to X[x]Y[y] size [size] character [s] shape[shape]',
				'WitCatMouse.url': 'upload ico and get base64',
				'WitCatMouse.click': 'click',
				'WitCatMouse.dclick': 'double-click',
				'WitCatMouse.mouse': 'mouse[way]?',
				'WitCatMouse.mousetd': 'When mouse[key]pressed[time]seconds',
				'WitCatMouse.mouset': 'mouse[key]hold time(sec)',
				'WitCatMouse.docs': 'ğŸ“–Tutorials',
				'WitCatInput.mousewheel': 'mouse wheel speed',
				'WitCatMouse.gyroscope': 'Current [p] axis Angle',
				'WitCatMouse.title': 'Set mouse prompts[text]',
				'WitCatMouse.titlenow': 'Let mouse prompts[text][show]',
				'WitCatMouse.show.1': 'show',
				'WitCatMouse.show.2': 'hide',
			},
		});
	}

	/**
	 * ç¿»è¯‘
	 * @param {string} id
	 * @returns {string}
	 */
	formatMessage(id) {
		return this._formatMessage({
			id,
			default: id,
			description: id,
		});
	}

	getInfo() {
		return {
			id: witcat_more_mouse_extensionId, // æ‹“å±•id
			name: this.formatMessage('WitCatMouse.name'), // æ‹“å±•å
			blockIconURI: witcat_more_mouse_icon,
			menuIconURI: witcat_more_mouse_icon,
			color1: '#8eace1',
			color2: '#86a2d4',
			blocks: [
				{
					blockType: 'button',
					text: this.formatMessage('WitCatMouse.docs'),
					onClick: this.docs,
				},
				{
					opcode: 'setfill',
					blockType: 'command',
					text: this.formatMessage('WitCatMouse.setfill'),
					arguments: {
						num: {
							type: 'number',
							defaultValue: '360',
						},
					},
				},
				{
					opcode: 'whenOutFill',
					blockType: 'hat',
					text: this.formatMessage('WitCatMouse.whenoutfill'),
					isEdgeActivated: false,
					arguments: {},
				},
				{
					opcode: 'isfill',
					blockType: 'Boolean',
					text: this.formatMessage('WitCatMouse.isfill'),
					arguments: {},
				},
				{
					opcode: 'fill',
					blockType: 'command',
					text: this.formatMessage('WitCatMouse.fill'),
					hideFromPalette: true,
					arguments: {
						set: {
							type: 'bool',
							menu: 'set',
						},
					},
				},
				{
					opcode: 'resolution',
					blockType: 'reporter',
					text: this.formatMessage('WitCatMouse.resolution'),
					arguments: {},
				},
				`---${this.formatMessage('WitCatMouse.name.1')}`,
				{
					opcode: 'title',
					blockType: 'command',
					text: this.formatMessage('WitCatMouse.title'),
					arguments: {
						text: {
							type: 'string',
							defaultValue: 'wit_cat!!!',
						},
					},
				},
				{
					opcode: 'titlenow',
					blockType: 'command',
					text: this.formatMessage('WitCatMouse.titlenow'),
					arguments: {
						text: {
							type: 'string',
							defaultValue: 'wit_cat!!!',
						},
						show: {
							type: 'string',
							menu: 'show',
						},
					},
				},
				{
					opcode: 'set',
					blockType: 'command',
					text: this.formatMessage('WitCatMouse.set'),
					arguments: {
						set: {
							type: 'bool',
							menu: 'set',
						},
					},
				},
				{
					opcode: 'when',
					blockType: 'Boolean',
					text: this.formatMessage('WitCatMouse.when'),
					arguments: {
						key: {
							type: 'string',
							menu: 'key',
						},
					},
				},
				{
					opcode: 'mouses',
					blockType: 'Boolean',
					text: this.formatMessage('WitCatMouse.mouse'),
					arguments: {
						way: {
							type: 'string',
							menu: 'ways',
						},
					},
				},
				{
					opcode: 'mousewheel',
					blockType: 'reporter',
					text: this.formatMessage('WitCatMouse.mousewheel'),
					arguments: {},
				},
				{
					opcode: 'mouse',
					blockType: 'hat',
					text: this.formatMessage('WitCatMouse.mouse'),
					arguments: {
						way: {
							type: 'string',
							menu: 'ways',
						},
					},
				},
				{
					opcode: 'mousetd',
					blockType: 'Boolean',
					text: this.formatMessage('WitCatMouse.mousetd'),
					arguments: {
						key: {
							type: 'number',
							menu: 'key',
						},
						time: {
							type: 'number',
							defaultValue: '1',
						},
					},
				},
				{
					opcode: 'mousetds',
					blockType: 'hat',
					text: this.formatMessage('WitCatMouse.mousetd'),
					arguments: {
						key: {
							type: 'number',
							menu: 'key',
						},
						time: {
							type: 'number',
							defaultValue: '1',
						},
					},
				},
				{
					opcode: 'mouset',
					blockType: 'reporter',
					text: this.formatMessage('WitCatMouse.mouset'),
					arguments: {
						key: {
							type: 'number',
							menu: 'key',
						},
					},
				},
				{
					blockType: 'button',
					text: this.formatMessage('WitCatMouse.url'),
					// è¿™é‡Œçš„ bind å¿…é¡»ï¼Œå› ä¸º this.url é‡Œé¢å¼•ç”¨äº† this
					onClick: this.url.bind(this),
				},
				{
					opcode: 'cursor',
					blockType: 'command',
					text: this.formatMessage('WitCatMouse.cursor'),
					arguments: {
						cursor: {
							type: 'string',
							menu: 'cursor',
						},
					},
				},
				{
					opcode: 'cursorurl',
					blockType: 'command',
					text: this.formatMessage('WitCatMouse.cursorurl'),
					arguments: {
						x: {
							type: 'number',
							defaultValue: '0',
						},
						y: {
							type: 'number',
							defaultValue: '0',
						},
						text: {
							type: 'string',
							defaultValue: 'base64:ico',
						},
					},
				},
				{
					opcode: 'cursorStyle',
					blockType: 'command',
					text: this.formatMessage('WitCatMouse.cursorstyle'),
					arguments: {
						x: {
							type: 'number',
							defaultValue: '0',
						},
						y: {
							type: 'number',
							defaultValue: '0',
						},
						size: {
							type: 'number',
							defaultValue: '64',
						},
						s: {
							type: 'string',
							menu: 'targetListMenu',
						},
						shape: {
							type: 'number',
							defaultValue: '1',
						},
					},
				},
				{
					opcode: 'mouseuse',
					blockType: 'command',
					text: this.formatMessage('WitCatMouse.mouseuse'),
					arguments: {
						mouseuse: {
							type: 'string',
							menu: 'mouseuse',
						},
					},
				},
				{
					opcode: 'acceleration',
					blockType: 'reporter',
					text: this.formatMessage('WitCatMouse.acceleration'),
					arguments: {
						way: {
							type: 'string',
							menu: 'way',
						},
					},
				},
				`---${this.formatMessage('WitCatMouse.name.2')}`,
				{
					opcode: 'down',
					blockType: 'reporter',
					text: this.formatMessage('WitCatTouch.down'),
					arguments: {},
				},
				{
					opcode: 'num',
					blockType: 'reporter',
					text: this.formatMessage('WitCatTouch.num'),
					arguments: {
						num: {
							type: 'number',
							defaultValue: '1',
						},
						type: {
							type: 'string',
							menu: 'type',
						},
					},
				},
				{
					opcode: 'info',
					blockType: 'reporter',
					text: this.formatMessage('WitCatTouch.info'),
					arguments: {
						num: {
							type: 'string',
							defaultValue: '0',
						},
						type: {
							type: 'string',
							menu: 'type',
						},
					},
				},
				{
					opcode: 'isTouch',
					blockType: 'Boolean',
					text: this.formatMessage('WitCatTouch.istouch'),
					arguments: {
						num: {
							type: 'string',
							defaultValue: '0',
						},
					},
				},
				{
					opcode: 'touchacceleration',
					blockType: 'reporter',
					text: this.formatMessage('WitCatMouse.touchacceleration'),
					arguments: {
						num: {
							type: 'string',
							defaultValue: '0',
						},
						way: {
							type: 'string',
							menu: 'wayss',
						},
					},
				},
				{
					opcode: 'touchs',
					blockType: 'reporter',
					text: this.formatMessage('WitCatTouch.touchs'),
					arguments: {},
				},
				{
					opcode: 'cantouch',
					blockType: 'Boolean',
					text: this.formatMessage('WitCatMouse.cantouch'),
					arguments: {
						type: {
							type: 'string',
							menu: 'types',
						},
					},
				},
				{
					opcode: 'IsMobile',
					blockType: 'Boolean',
					text: this.formatMessage('WitCatMouse.IsMobile'),
					arguments: {},
				},
				{
					opcode: 'gyroscope',
					blockType: 'reporter',
					text: this.formatMessage('WitCatMouse.gyroscope'),
					hideFromPalette: true,
					arguments: {
						p: {
							type: 'string',
							menu: 'rot',
						},
					},
				},
			],
			menus: {
				key: [
					{
						text: this.formatMessage('WitCatMouse.key.1'),
						value: '0',
					},
					{
						text: this.formatMessage('WitCatMouse.key.2'),
						value: '1',
					},
					{
						text: this.formatMessage('WitCatMouse.key.3'),
						value: '2',
					},
					{
						text: this.formatMessage('WitCatMouse.key.4'),
						value: '3',
					},
					{
						text: this.formatMessage('WitCatMouse.key.5'),
						value: '4',
					},
				],
				cursor: {
					acceptReporters: true,
					items: [
						{
							text: this.formatMessage('WitCatMouse.cursor.1'),
							value: 'default',
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.2'),
							value: 'text',
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.3'),
							value: 'move',
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.4'),
							value: 'n-resize',
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.5'),
							value: 'e-resize',
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.6'),
							value: 'not-allowed',
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.7'),
							value: 'pointer',
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.8'),
							value: 'progress',
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.9'),
							value: 'wait',
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.10'),
							value: 'help',
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.11'),
							value: 'vertical-text',
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.12'),
							value: 'crosshair',
						},
					],
				},
				set: [
					{
						text: this.formatMessage('WitCatMouse.set.1'),
						value: 'true',
					},
					{
						text: this.formatMessage('WitCatMouse.set.2'),
						value: 'false',
					},
				],
				way: [
					{
						text: this.formatMessage('WitCatMouse.way.1'),
						value: 'x',
					},
					{
						text: this.formatMessage('WitCatMouse.way.2'),
						value: 'y',
					},
				],
				wayss: [
					{
						text: this.formatMessage('WitCatMouse.way.1'),
						value: 'x',
					},
					{
						text: this.formatMessage('WitCatMouse.way.2'),
						value: 'y',
					},
					{
						text: this.formatMessage('WitCatMouse.way.4'),
						value: 's',
					},
				],
				rot: [
					{
						text: this.formatMessage('WitCatMouse.way.1'),
						value: 'x',
					},
					{
						text: this.formatMessage('WitCatMouse.way.2'),
						value: 'y',
					},
					{
						text: this.formatMessage('WitCatMouse.way.3'),
						value: 'z',
					},
				],
				ways: [
					{
						text: this.formatMessage('WitCatMouse.click'),
						value: 'click',
					},
					{
						text: this.formatMessage('WitCatMouse.dclick'),
						value: 'dclick',
					},
				],
				type: [
					{
						text: this.formatMessage('WitCatTouch.type.1'),
						value: 'x',
					},
					{
						text: this.formatMessage('WitCatTouch.type.2'),
						value: 'y',
					},
					{
						text: this.formatMessage('WitCatTouch.type.3'),
						value: 'ID',
					},
					{
						text: this.formatMessage('WitCatTouch.type.4'),
						value: 'press',
					},
				],
				types: [
					{
						text: this.formatMessage('WitCatMouse.types.1'),
						value: 'ontouchstart',
					},
					{
						text: this.formatMessage('WitCatMouse.types.2'),
						value: 'onmousedown',
					},
				],
				mouseuse: [
					{
						text: this.formatMessage('WitCatMouse.mouseuse.1'),
						value: 'lock',
					},
					{
						text: this.formatMessage('WitCatMouse.mouseuse.2'),
						value: 'release',
					},
				],
				show: [
					{
						text: this.formatMessage('WitCatMouse.show.1'),
						value: 'true',
					},
					{
						text: this.formatMessage('WitCatMouse.show.2'),
						value: 'false',
					},
				],
				targetListMenu: {
					items: "buildTargetListMenu"
				}
			},
		};
	}

	/**
	 * buildTargetListMenuèœå•
	 * @returns èœå•
	 */
	buildTargetListMenu() {
		return this._spriteMenu();
	}

	/**
	 * ä»runtimeè·å–èœå•
	 * @returns èœå•
	 */
	_spriteMenu() {
		let e = [];
		return this.runtime.targets.forEach((function (t) {
			t.isOriginal && !t.isStage && e.push({
				text: t.sprite.name,
				value: t.sprite.name
			})
		})), 0 === e.length && e.push({
			text: this.formatMessage({
				id: "GandiAsyncAssetManager.noneSprite",
				default: "none sprite"
			}),
			value: ""
		}), e
	}

	/**
	 * å¯ç”¨å³é”®èœå•ï¼Ÿ
	 * @param {object} args
	 * @param {SCarg} args.set
	 */
	set(args) {
		const canvas = this.canvas();
		if (canvas === null) {
			return;
		}
		// åœ¨æŠŠè‡ªå·±çš„æ–¹æ³•è®¾ä¸ºç»™å…¶ä»–äº‹ä»¶/å‡½æ•°çš„å›è°ƒæ—¶åŠ ä¸Š bind(this) æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œ
		// ç¡®ä¿å›è°ƒå‡½æ•°è§¦å‘æ—¶ï¼Œé‡Œé¢çš„ this æŒ‡å‘è‡ªå·±ã€‚
		// ä¸è¿‡å›è°ƒå‡½æ•°é‡Œé¢æ²¡æœ‰ç”¨åˆ° thisï¼Œæ‰€ä»¥æ˜¯å¦æœ‰è¿™ä¸ª bind æ²¡æœ‰åŒºåˆ«ã€‚
		// å¦‚æœåŠ ä¸Šäº† bindï¼Œå› ä¸ºæ¯æ¬¡ bind() éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°å‡½æ•°ï¼Œ
		// removeEventListener çš„æ—¶å€™å°±ä¼šå› ä¸ºå‡½æ•°ä¸ä¸€è‡´å¯¼è‡´ remove ä¸æ‰ï¼Œ
		// éœ€è¦æå‰æŠŠ bind è¿‡çš„å‡½æ•°è®¾ä¸ºæŸç±»å†…å˜é‡ã€‚
		if (args.set === 'false') {
			canvas.addEventListener('contextmenu', this._nocontextmenu);
		} else {
			canvas.removeEventListener('contextmenu', this._nocontextmenu);
		}
	}

	/**
	 * ç¦ç”¨å³é”®èœå•ç”¨çš„äº‹ä»¶æ•è·å‡½æ•°
	 * @param {Event} event
	 */
	_nocontextmenu(event) {
		// é˜»æ­¢å³é”®èœå•
		event.preventDefault();
	}

	/**
	 * æŒ‰ä¸‹åˆ¤æ–­
	 * @param {object} args
	 * @param {SCarg} args.key
	 */
	when(args) {
		return this.button[Number(args.key)] === 'down';
	}

	/**
	 * æ§åˆ¶é¼ æ ‡
	 * @param {object} args
	 * @param {SCarg} args.mouseuse
	 */
	mouseuse(args) {
		if (args.mouseuse === 'release') {
			document.exitPointerLock();
		} else {
			document.body.requestPointerLock();
		}
	}

	/**
	 * é¼ æ ‡ç§»åŠ¨é‡
	 * @param {object} args
	 * @param {SCarg} args.way
	 * @returns {number}
	 */
	acceleration(args) {
		if (args.way === 'x') {
			return this.xMouse;
		}
		return -this.yMouse;
	}

	/**
	 * æ‰‹æŒ‡æ•°é‡
	 * @returns {number}
	 */
	down() {
		return this.touch.length;
	}

	/**
	 * åæ ‡
	 * @param {object} args
	 * @param {SCarg} args.num æ‰‹æŒ‡ç¼–å·
	 * @param {SCarg} args.type æ•°æ®ç±»å‹ "x"|"y"|"identifier"
	 * @returns {number|string}
	 */
	num(args) {
		const canvas = this.canvas();
		if (canvas === null) {
			return 0;
		}
		const touch1 = this.touch[Number(args.num) - 1];
		if (touch1 !== undefined) {
			if (args.type === 'x') {
				return this.runtime.stageWidth * ((touch1.clientX - canvas.getBoundingClientRect().left) / canvas.offsetWidth);
			}
			if (args.type === 'y') {
				return this.runtime.stageHeight * ((touch1.clientY - canvas.getBoundingClientRect().top) / canvas.offsetHeight);
			}
			if (args.type === 'press') {
				return "true";
			}
			return touch1.identifier;
		}
		if (args.type === 'press') {
			return "false";
		}
		return 0;
	}

	/**
	 * åæ ‡
	 * @param {object} args
	 * @param {SCarg} args.num æ‰‹æŒ‡ID
	 * @param {SCarg} args.type æ•°æ®ç±»å‹ "x"|"y"|"identifier"
	 * @returns {number|string}
	 */
	info(args) {
		const canvas = this.canvas();
		if (canvas === null) {
			return 0;
		}
		for (let i = 0; i < this.touch.length; i++) {
			if (String(this.touch[i]["identifier"]) === String(args.num)) {
				if (this.touch[i] !== undefined) {
					if (args.type === 'x') {
						return this.runtime.stageWidth * ((this.touch[i].clientX - canvas.getBoundingClientRect().left) / canvas.offsetWidth);
					}
					if (args.type === 'y') {
						return this.runtime.stageHeight * ((this.touch[i].clientY - canvas.getBoundingClientRect().top) / canvas.offsetHeight);
					}
					if (args.type === 'press') {
						return "true";
					}
					return touch1.identifier;
				}
			}
		}
		if (args.type === 'press') {
			return "false";
		}
		return 0;
	}

	/**
	 * å…¨å±
	 * @deprecated
	 */
	fill(args) {
		console.warn('å…¨å±å› æµè§ˆå™¨å…¼å®¹é—®é¢˜å·²ä¸‹çº¿ï¼Œå¹¶ä¸ä¼šå†ä¸Šçº¿\nFull screen has been taken offline due to browser compatibility issues. And never back online.')
	}

	whenOutFill() {
		return true;
	}

	isfill() {
		return Boolean(document.fullscreenElement);
	}

	/**
	 * è®¾ç½®åˆ†è¾¨ç‡
	 * @deprecated
	 */
	setfill(args) {
		if (Date.now() - this.LastSet > 1000) {
			this.LastSet = Date.now();
			const canvas = this.canvasSelf();
			if (canvas === null) {
				return 0;
			}
			if (Number(args.num) < window.screen.height) {
				this.runtime.renderer.resize((Number(args.num) * this.runtime.stageWidth) / this.runtime.stageHeight, Number(args.num));
			} else {
				console.warn("åˆ†è¾¨ç‡è¶…è¿‡å±å¹•ï¼Œå°†äº§ç”Ÿé¢å¤–æ€§èƒ½æ¶ˆè€—\nResolution exceeding the screen will incur additional performance costs");
			}
		} else {
			console.warn("è®¾ç½®åˆ†è¾¨ç‡å¤ªè¿‡é¢‘ç¹\nSetting the resolution too often");
		}
	}

	/**
	 * å½“å‰åˆ†è¾¨ç‡
	 * @returns {number}
	 */
	resolution() {
		const canvas = this.canvasSelf();
		if (canvas === null) {
			return 0;
		}
		return canvas.height;
	}

	/**
	 * è®¾å¤‡æ˜¯å¦æ”¯æŒè§¦å±/é¼ æ ‡
	 * @param {object} args
	 * @param {SCarg} args.type
	 * @returns {boolean}
	 */
	cantouch(args) {
		return args.type in document.documentElement;
	}

	/**
	 * æ˜¯å¦æ˜¯æ‰‹æœº
	 * @returns {boolean}
	 */
	IsMobile() {
		return /Android|iPhone|iPad|iPod|BlackBerry|webOS|Windows Phone|SymbianOS|IEMobile|Opera Mini/i.test(
			navigator.userAgent
		);
	}

	/**
	 * è®¾ç½®å…‰æ ‡æ ·å¼
	 * @param {object} args
	 * @param {SCarg} args.cursor æ ·å¼
	 */
	cursor(args) {
		const canvasParent = this.canvas()?.parentNode?.parentNode?.parentNode;
		if (canvasParent === null || canvasParent === undefined) {
			return;
		}
		canvasParent.style.cursor = String(args.cursor);
	}

	/**
	 * è®¾ç½®å…‰æ ‡ä¸ºurl
	 * @param {object} args
	 * @param {SCarg} args.text æ ·å¼
	 * @param {SCarg} args.x xåç§»
	 * @param {SCarg} args.y yåç§»
	 */
	cursorurl(args) {
		const canvasParent = this.canvas()?.parentNode?.parentNode?.parentNode;
		if (canvasParent === null || canvasParent === undefined) {
			return;
		}
		let url = String(args.text);
		const x = Number(args.x);
		const y = Number(args.y);
		// é’ˆå¯¹ url() é‡Œçš„è¯­æ³•ï¼Œè½¬ä¹‰ã€‚
		url = url.replace(/"/g, '%22').replace(/\n/g, '%0D').replace(/\r/g, '%0A').replace(/\0/g, '%00');
		// å®é™…ä¸Š cursorurl å¤„å¯ä»¥ç›´æ¥ä½¿ç”¨ æ­£å¸¸çš„ url å’Œ data urlã€‚
		// ä¸éœ€è¦ç‰¹åœ°è½¬æ¢ã€‚
		canvasParent.style.cursor = `url("${url}") ${x} ${y}, auto`;
	}

	/**
	 * è®¾ç½®å…‰æ ‡ä¸ºé€ å‹
	 * @param {object} args
	 * @param {SCarg} args.s ç›®æ ‡è§’è‰²
	 * @param {SCarg} args.size å¤§å°
	 * @param {SCarg} args.x xåç§»
	 * @param {SCarg} args.y yåç§»
	 */
	cursorStyle(args) {
		const canvasParent = this.canvas()?.parentNode?.parentNode?.parentNode;
		if (canvasParent === null || canvasParent === undefined) {
			return;
		}
		const targetRoleName = String(args.s);

		const x = Number(args.x);
		const y = Number(args.y);
		const size = Number(args.size);
		const targetCostumeIndex = Number(args.shape - 1);
		const targetSprite = this.runtime.targets.find((v) => { return v.sprite.name === targetRoleName });
		if (targetSprite) {
			try {
				const targetCostume = targetSprite.sprite.costumes_[targetCostumeIndex];

				const costumeURL = this.Uint8ArrayToString(targetCostume.asset.data);
				const width = targetCostume.size[0];
				const height = targetCostume.size[1];

				let sizes = 0;
				if (width < height) {
					sizes = size / height;
				}
				else {
					sizes = size / width;
				}

				const svgDataUri = (targetCostume.asset.assetType.contentType === 'image/png' ? 'data:image/png;base64,' : 'data:image/svg+xml;base64,') + btoa(costumeURL);
				const canvas = document.createElement('canvas');
				canvas.width = size;
				canvas.height = size;
				const ctx = canvas.getContext('2d');

				const svgImage = new Image();
				svgImage.src = svgDataUri;
				svgImage.onload = function () {
					ctx.drawImage(svgImage, 0, 0, width * sizes, height * sizes);
					const icoDataUri = canvas.toDataURL('image/x-icon');

					canvasParent.style.cursor = `url("data:image/x-icon;${icoDataUri.split(";")[1]}") ${x} ${y}, auto`;
				};
			}
			catch (e) {
				console.error("Target modeling does not exist: " + targetCostumeIndex + "\nmore infoï¼š" + "\n" + e);
			}
		} else {
			console.error("Target role not found: " + targetRoleName);
		}
	}

	/**
	 * é¼ æ ‡æç¤ºæ–‡æ¡ˆ
	 * @param {Object} args 
	 */
	title(args) {
		const canvasParent = this.canvas()?.parentNode?.parentNode?.parentNode;
		if (canvasParent === null || canvasParent === undefined) {
			return;
		}
		canvasParent.title = String(args.text);
	}

	titlenow(args) {
		const canvas = this.canvas();
		if (canvas === null) {
			return;
		}
		if (args.show === 'true') {
			if (this.titleDiv == null) {
				this.titleDiv = document.createElement("div");
				this.titleDiv.innerText = String(args.text);
				this.titleDiv.style = `transition: transform 0.2s ease-in-out;transform: scale(0, 0);z-index: 10000;border:1px solid #000000 ;transform-origin:0px 0px;border-radius:10px;background-color:#ffffff;padding:5px;position:fixed;top:${this.MouseY + 10}px;left:${this.MouseX + 10}px`;
				this.MouseTitle = setInterval(() => {
					this.titleDiv.style.top = (this.MouseY + 10) + 'px';
					this.titleDiv.style.left = (this.MouseX + 10) + 'px';
				}, 1);
				canvas.append(this.titleDiv);
				setTimeout(() => {
					this.titleDiv.style.transform = 'scale(1, 1)';
				}, 10);
			}
			else if (String(args.text) !== this.titleDiv.innerText) {
				setTimeout(() => {
					this.titleDiv.style.transform = 'scale(0, 0)';
					setTimeout(() => {
						this.titleDiv.innerText = String(args.text);
						this.titleDiv.style.transform = 'scale(1, 1)';
					}, 200);
				}, 200);
			}
		}
		else {
			if (this.MouseTitle !== null) {
				clearInterval(this.MouseTitle);
				this.MouseTitle = null;
				this.titleDiv.style.transform = 'scale(0, 0)';
				setTimeout(() => {
					document.body.removeChild(this.titleDiv);
					this.titleDiv = null;
				}, 200);
			}
		}
	}

	/**
	 * å°†Uint8Arrayç¼–ç çš„æ–‡æœ¬è½¬æ¢ä¸ºstring
	 * @param {Uint8Array} fileData éœ€è¦è½¬æ¢çš„æ–‡ä»¶
	 * @returns {string} è½¬æ¢åçš„æ–‡æœ¬
	 */
	Uint8ArrayToString(fileData) {
		let dataString = "";
		for (let i = 0; i < fileData.length; i++) {
			dataString += String.fromCharCode(fileData[i]);
		}
		return dataString
	}

	/**
	 * æ‰“å¼€æ–‡ä»¶é€‰æ‹©æ¡†
	 * @param {string} accept æ¥å—çš„æ–‡ä»¶æ‰©å±•å
	 * @param {boolean} multiple æ¥å—å¤šä¸ªæ–‡ä»¶
	 * @return {Promise<File[]>} [å¼‚æ­¥åœ°]è¿”å›é€‰æ‹©åçš„æ–‡ä»¶åˆ—è¡¨input.filesè½¬æ¢æˆçš„æ•°ç»„(å¯èƒ½æ²¡æœ‰æ–‡ä»¶)
	 */
	_inputfileclick(accept, multiple) {
		return new Promise((resolve, reject) => {
			const input = document.createElement('input');
			input.type = 'file';
			input.accept = accept;
			input.style.display = 'none';
			input.multiple = multiple;
			input.click();
			input.addEventListener(
				'change',
				() => {
					if (input.files === null) {
						reject(new Error('ä¸åº”è¯¥çœ‹åˆ°è¿™ä¸ª'));
					} else {
						// è¿”å›äº†å…³é”®çš„ input.filesï¼Œè€Œä¸æ˜¯æ•´ä¸ª inputã€‚
						// ä¹‹åå¦‚æœè¦è€ƒè™‘â€œè¯»å–ç´ æåº“æ–‡ä»¶â€ï¼Œâ€œæ‹–åŠ¨å¯¼å…¥æ–‡ä»¶â€ç­‰
						// åªèƒ½è·å¾— Blob/File çš„æƒ…å†µï¼Œå¯ä»¥æ–¹ä¾¿é€‚é…
						// è¿™é‡ŒåŠ  Array.from æ˜¯å› ä¸º input.files æ˜¯ FileListï¼Œ
						// ä¸æ˜¯ File[]ï¼Œä¸€äº›æ•°ç»„æ‹¥æœ‰çš„åŠŸèƒ½å®ƒæ²¡æœ‰ã€‚è™½ç„¶ä¸€èˆ¬æƒ…å†µä¸‹
						// ä¸ä¼šæ³¨æ„åˆ°åŒºåˆ«ï¼Œä½†æ˜¯ç±»å‹æ£€æŸ¥ä¼šæŠŠè¿™ç§æƒ…å†µæŸ¥å‡ºæ¥ã€‚
						resolve(Array.from(input.files));
					}
				},
				{ once: true }
			); // åªè§¦å‘ä¸€æ¬¡
			window.addEventListener(
				'focus',
				() => {
					setTimeout(() => {
						if (input.files === null) {
							reject(new Error('ä¸åº”è¯¥çœ‹åˆ°è¿™ä¸ª'));
						} else {
							resolve(Array.from(input.files));
						}
					}, 1000);
				},
				{ once: true }
			); // åªè§¦å‘ä¸€æ¬¡
		});
	}

	/**
	 * è¯»å–æ–‡ä»¶
	 * @param {File|Blob} file File æˆ–è€… Blob
	 * @param {"arraybuffer"|"dataurl"|"text"} mode è¯»å–æ¨¡å¼
	 * @return {Promise<string|ArrayBuffer|null>} [å¼‚æ­¥åœ°]è¿”å›è¯»å–åçš„å†…å®¹
	 */
	_readerasync(file, mode) {
		return new Promise((resolve, reject) => {
			const reader = new FileReader();
			reader.onload = () => {
				resolve(reader.result);
			};
			reader.onerror = (e) => {
				reject(e);
			};
			switch (mode) {
				case 'arraybuffer':
					reader.readAsArrayBuffer(file);
					break;
				case 'dataurl':
					reader.readAsDataURL(file);
					break;
				case 'text':
					reader.readAsText(file);
					break;
				default:
					reject(new Error('mode é”™è¯¯: åº”è¯¥æ˜¯ arraybuffer, dataurl æˆ–è€… text'));
			}
		});
	}

	/**
	 * è·å–ç§»åŠ¨ç«¯è®¾å¤‡è§’åº¦
	 * @param {JSON} args 
	 */
	gyroscope(args) {
		try {
			switch (args.p) {
				case 'x':
					return this.Gyroscope.beta;
				case 'y':
					return this.Gyroscope.gamma;
				case 'z':
					return this.Gyroscope.alpha;
			}
			return "";
		}
		catch (e) {
			//è®¾å¤‡å¯èƒ½æ˜¯ç”µè„‘
			return "";
		}
	}

	/**
	 * æ‰“å¼€icoæ–‡ä»¶
	 */
	async url() {
		const file = (await this._inputfileclick('.ico', false))[0];
		if (file !== undefined) {
			// åŠ ä¸€ä¸ªæ‰©å±•ååˆ¤æ–­ï¼Ÿ
			const dataurl = String(await this._readerasync(file, 'dataurl'));
			let div = document.createElement('div');
			div.style.position = 'fixed';
			div.style.top = '0px';
			div.style.left = '0px';
			div.style.width = '100%';
			div.style.height = '100%';
			div.style.zIndex = '9999';
			div.style.transition = 'all 0.2s ease-out';
			div.style.backgroundColor = '#00000000';
			div.innerHTML = `
<div id="myModal" class="modal">
<div class="modals">
  <span class="close">
      &times;
  </span>
  <h5>${this.formatMessage('WitCatMouse.copythis')}</h5>
  <div class="modal-content">
  <p>${dataurl}</p>
  </div>
</div>
</div>
<style>
.modal{
	height:0%;
	transition:all 0.2s ease-out;
}

.modal-content {
	margin-top:16px;
	height:calc(100% - 16px);
	overflow: scroll;
}
.modals{
    background-color: #00000000;
    margin: 15% auto; 
    padding: 20px;
	border-radius:20px;
    width: 50%; 
    height:50%;
    position:relative;
}
 
.modal-content::-webkit-scrollbar-corner {
  background-color: transparent;
}

.modal-content p,.modals h5 {
    color: var(--theme-text-primary);
}

.modals h5 {
	font-size: 20px;
}

.close {
  cursor: pointer;
  position:absolute;
  top:0;
  right:10px;
  color:#aaa;
  font-size:28px;
  font-weight:bold;
}

//å…³é—­ç‰¹æ•ˆ
.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
}

</style>
`;
			document.body.appendChild(div);

			let modal = document.getElementById('myModal');
			let span = document.querySelector('.close');
			//åˆ›å»ºç‚¹å‡»äº‹ä»¶
			span.onclick = function () {
				div.style.backgroundColor = '#00000000';
				modal.style.height = '0%';
				document.getElementsByClassName('modals')[0].style.backgroundColor = '#00000000';
				setTimeout(() => {
					div.remove();
				}, 180);
			}
			// åœ¨ç”¨æˆ·ç‚¹å‡»å…¶ä»–åœ°æ–¹æ—¶ï¼Œå…³é—­å¼¹çª—
			document.addEventListener("click", function (event) {
				if (event.target == modal) {
					div.style.backgroundColor = '#00000000';
					modal.style.height = '0%';
					document.getElementsByClassName('modals')[0].style.backgroundColor = '#00000000';
					setTimeout(() => {
						div.remove();
					}, 180);
				}
			})
			setTimeout(() => {
				div.style.backgroundColor = 'var(--theme-scrollbar-color)';
				modal.style.height = '80%';
				document.getElementsByClassName('modals')[0].style.backgroundColor = 'var(--theme-color-300)';
			}, 100);
		}
	}

	/**
	 * æ‰“å¼€æ•™ç¨‹
	 */
	docs() {
		const a = document.createElement('a');
		a.href = 'https://www.ccw.site/post/c36aa805-b29d-48da-aba1-468a6cf80bfa';
		a.rel = 'noopener noreferrer';
		a.target = '_blank';
		a.click();
	}

	/**
	 * é¼ æ ‡ç‚¹å‡»/åŒå‡»
	 * @param {object} args
	 * @param {SCarg} args.way ç‚¹å‡»/åŒå‡»
	 * @returns {boolean}
	 */
	mouse(args) {
		if (args.way === 'click') {
			return this.click !== false;
		}
		if (args.way === 'dclick') {
			return this.dclick !== false;
		}
		return false;
	}

	/**
	 * é¼ æ ‡æ»šè½®é€Ÿåº¦
	 * @returns {number}
	 */
	mousewheel() {
		return this.MouseWheel;
	}

	/**
	 * é¼ æ ‡ç‚¹å‡»/åŒå‡»(å¸½å­ç§¯æœ¨)
	 * @param {object} args
	 * @param {SCarg} args.way ç‚¹å‡»/åŒå‡»
	 * @returns {boolean}
	 */
	mouses(args) {
		return this.mouse(args);
	}

	/**
	 * åˆ¤æ–­é¼ æ ‡é”®æŒ‰ä¸‹æ—¶é•¿
	 * @param {object} args
	 * @param {SCarg} args.key æŒ‰é”®ç¼–å·
	 * @param {SCarg} args.time æŒ‰é”®æ—¶é•¿
	 * @returns {boolean}
	 */
	mousetd(args) {
		const mousetdkey = this.mousetdlist[Number(args.key)];
		if (mousetdkey !== undefined && mousetdkey !== '') {
			const time = Date.now() - (Number(args.time) * 1000 + mousetdkey);
			if (time >= -50 && time <= 50) {
				return true;
			}
		}
		return false;
	}

	touchacceleration(args) {
		for (let i = 0; i < this.touch.length; i++) {
			if (String(this.touch[i]["identifier"]) === String(args.num)) {
				if (this.touch[i] !== undefined) {
					if (args.way === 'x') {
						return this.touch[i].Xspeed;
					}
					else if (args.way === 'y') {
						return this.touch[i].Yspeed;
					}
					else {
						return this.touch[i].speed;
					}
				}
			}
		}
		return 0;
	}

	/**
	 * åˆ¤æ–­æ˜¯å¦ç¢°åˆ°æŸä¸ªæ‰‹æŒ‡
	 * @param {*} args 
	 * @param {*} util 
	 * @returns 
	 */
	isTouch(args, util) {
		const canvas = this.canvas();
		for (let i = 0; i < this.touch.length; i++) {
			if (String(this.touch[i]["identifier"]) === String(args.num)) {
				if (this.touch[i] !== undefined) {
					let x = (this.touch[i].clientX - canvas.getBoundingClientRect().left);
					let y = (this.touch[i].clientY - canvas.getBoundingClientRect().top);
					return util.target.isTouchingPoint(x, y);
				}
			}
		}
		return false;
	}


	/**
	 * è¿”å›ç¢°åˆ°çš„æ‰‹æŒ‡IDåˆ—è¡¨
	 * @param {Object} args 
	 * @param {Object} util 
	 * @returns 
	 */
	touchs(args, util) {
		const canvas = this.canvas();
		let s = [];
		for (let i = 0; i < this.touch.length; i++) {
			let x = (this.touch[i].clientX - canvas.getBoundingClientRect().left);
			let y = (this.touch[i].clientY - canvas.getBoundingClientRect().top);
			if (util.target.isTouchingPoint(x, y)) {
				s.push(this.touch[i]["identifier"]);
			}
		}
		return JSON.stringify(s);
	}

	/**
	 * åˆ¤æ–­é¼ æ ‡é”®æŒ‰ä¸‹æ—¶é•¿(å¸½å­ç§¯æœ¨)
	 * @param {object} args
	 * @param {SCarg} args.key æŒ‰é”®ç¼–å·
	 * @param {SCarg} args.time æŒ‰é”®æ—¶é•¿
	 * @returns {boolean}
	 */
	mousetds(args) {
		return this.mousetd(args);
	}

	/**
	 * é¼ æ ‡è¢«æŒ‰ä¸‹çš„æ—¶é—´
	 * @param {object} args
	 * @param {SCarg} args.key æŒ‰é”®ç¼–å·
	 * @returns {number}
	 */
	mouset(args) {
		const mousetdkey = this.mousetdlist[Number(args.key)];
		if (mousetdkey !== undefined && mousetdkey !== '') {
			return (Date.now() - mousetdkey) / 1000;
		}
		return 0;
	}

	/**
	 * å¤åˆ¶è§¦æ‘¸ç‚¹æ•°
	 * @param {TouchList} touches
	 */
	_copytouch(touches) {
		let x, y;
		this.touch = Array.from(touches).map((touch) => {
			for (let i = 0; i < this.touch.length; i++) {
				if (String(this.touch[i]["identifier"]) === String(touch.identifier)) {
					if (this.touch[i] !== undefined) {
						x = this.touch[i].clientX;
						y = this.touch[i].clientY;
						break;
					}
				}
			}
			return {
				clientX: touch.clientX,
				clientY: touch.clientY,
				Xspeed: touch.clientX - x,
				Yspeed: touch.clientY - y,
				speed: Math.sqrt((touch.clientX - x) * (touch.clientX - x) + (touch.clientY - y) * (touch.clientY - y)),
				identifier: touch.identifier,
			};
		});
	}

	/** æ·»åŠ äº‹ä»¶è§¦å‘å™¨ */
	_addevent() {
		const canvas = this.canvas();
		if (canvas === null) {
			return;
		}
		// é¼ æ ‡
		document.addEventListener('mousedown', (e) => {
			this.button[e.button] = 'down';
			this.mousetdlist[e.button] = Date.now();
			if (this.button[0] === 'down') {
				this.touch = [
					{
						clientX: e.clientX,
						clientY: e.clientY,
						identifier: 'mouse',
					},
				];
			}
		});
		document.addEventListener('mouseup', (e) => {
			this.button[e.button] = 'up';
			this.mousetdlist[e.button] = '';
			this.touch = [];
		});
		document.addEventListener('mousemove', (ev) => {
			if (this.button[0] === 'down') {
				this.touch = [
					{
						clientX: ev.clientX,
						clientY: ev.clientY,
						identifier: 'mouse',
					},
				];
			} else {
				this.touch = [];
			}
			this.MouseX = ev.clientX;
			this.MouseY = ev.clientY;
			this.xMouse = ev.movementX; // è·å¾—é¼ æ ‡æŒ‡é’ˆçš„xç§»åŠ¨é‡
			this.yMouse = ev.movementY; // è·å¾—é¼ æ ‡æŒ‡é’ˆçš„yç§»åŠ¨é‡
			if (this.timer !== null) {
				clearTimeout(this.timer);
			}
			this.timer = setTimeout(() => {
				this.xMouse = 0;
				this.yMouse = 0;
			}, 30);
		});
		// å¤šæŒ‡è§¦æ§
		canvas.addEventListener('touchstart', (e) => {
			// e.targetTouches ä¼šéšç€æ—¶é—´æ”¹å˜ï¼Œå¿…é¡»å¤åˆ¶ä¸€ä»½ã€‚
			this._copytouch(e.targetTouches);
			this.button[0] = 'down';
			this.mousetdlist[0] = Date.now();
		});
		canvas.addEventListener('touchmove', (e) => {
			if (e.targetTouches[0] !== undefined && this.touch[0] !== undefined) {
				this.xMouse = e.targetTouches[0].clientX - this.touch[0].clientX; // è·å¾—æ‰‹æŒ‡çš„xç§»åŠ¨é‡
				this.yMouse = e.targetTouches[0].clientY - this.touch[0].clientY; // è·å¾—æ‰‹æŒ‡çš„yç§»åŠ¨é‡
			}
			if (this.timer !== null) {
				clearTimeout(this.timer);
			}
			this.timer = setTimeout(() => {
				this.xMouse = 0;
				this.yMouse = 0;
			}, 30);
			// e.targetTouches ä¼šéšç€æ—¶é—´æ”¹å˜ï¼Œå¿…é¡»å¤åˆ¶ä¸€ä»½ã€‚
			if (this.timer !== null) {
				clearTimeout(this.touchtimer);
			}
			this.touchtimer = setTimeout(() => {
				for (let i = 0; i < this.touch.length; i++) {
					this.touch[i].Xspeed = 0;
					this.touch[i].Yspeed = 0;
					this.touch[i].speed = 0;
				}
			}, 30);
			this._copytouch(e.targetTouches);
		});
		canvas.addEventListener('touchend', (e) => {
			// e.targetTouches ä¼šéšç€æ—¶é—´æ”¹å˜ï¼Œå¿…é¡»å¤åˆ¶ä¸€ä»½ã€‚
			this._copytouch(e.targetTouches);
			this.mousetdlist[0] = '';
			this.button[0] = 'up';
		});
		document.addEventListener('click', () => {
			if (this.click !== false) {
				clearTimeout(this.click);
			}
			this.click = setTimeout(() => {
				this.click = false;
			}, 50);
		});
		document.addEventListener('dblclick', () => {
			if (this.dclick !== false) {
				clearTimeout(this.dclick);
			}
			this.dclick = setTimeout(() => {
				this.dclick = false;
			}, 50);
		});
		// ç»™é¡µé¢ç»‘å®šæ»‘è½®æ»šåŠ¨äº‹ä»¶
		document.addEventListener('wheel', (e) => {
			clearTimeout(this.timer);
			this.MouseWheel = e.deltaY;
			this.timer = setTimeout(() => {
				this.MouseWheel = 0;
			}, 30);
		}, { capture: true });
		window.addEventListener('deviceorientation', (e) => {
			this.Gyroscope = e;
		});
	}
}

window.tempExt = {
	Extension: WitCatMouse,
	info: {
		name: "WitCatMouse.name",
		description: "WitCatMouse.descp",
		extensionId: witcat_more_mouse_extensionId,
		iconURL: witcat_more_mouse_picture,
		insetIconURL: witcat_more_mouse_icon,
		featured: true,
		disabled: false,
		collaborator: "ç™½çŒ« @ CCW"
	},
	l10n: {
		"zh-cn": {
			"WitCatMouse.name": "ç™½çŒ«çš„é«˜çº§é¼ æ ‡ V3.3",
			"WitCatMouse.descp": "æ›´ç²¾å‡†çš„æ§åˆ¶é¼ æ ‡/è§¦å±/å…¨å±ï¼"
		},
		en: {
			"WitCatMouse.name": "WitCatâ€™s Mouse V3.3",
			"WitCatMouse.descp": "More precise mouse/touch/full screen control!"
		}
	}
};

/**
 * è®¡ç®—èˆå°åœ¨å…¨å±/éå…¨å±çš„å¤§å°
 * @param {Element} element éœ€è¦è¢«è®¡ç®—ä¸­å¿ƒç‚¹çš„è§’è‰²
 * @param {Boolean} type æ¨¡å¼ï¼ˆtrueï¼šæœ€å°åŒ–ï¼Œfalseï¼šå…¨å±ï¼‰
 */
function resizeElementInParent(element, type, types, aspectRatio) {
	let parentWidth, parentHeight;

	if (type) {
		let parent
		if (types === 'zoom') {
			parent = element.parentElement.parentElement;
		}
		else {
			parent = element.parentElement;
		}
		parentWidth = parent.clientWidth;
		parentHeight = parent.clientHeight;
	} else {
		parentWidth = document.body.clientWidth;
		parentHeight = document.body.clientHeight;
	}

	let elementWidth = element.offsetWidth;
	let elementHeight = element.offsetHeight;

	if (types === 'zoom') {
		let widthRatio = parentWidth / elementWidth;
		let heightRatio = parentHeight / elementHeight;
		let scale = Math.min(widthRatio, heightRatio);
		element.style.transform = 'scale(' + scale + ')';
	} else {
		if (parentWidth / parentHeight > aspectRatio) {
			element.style.height = parentHeight + 'px';
			element.style.width = parentWidth / (aspectRatio / (parentWidth / parentHeight)) + 'px';
		} else {
			element.style.width = parentWidth + 'px';
			element.style.height = parentHeight / (aspectRatio / (parentWidth / parentHeight)) + 'px';
		}
	}
}
