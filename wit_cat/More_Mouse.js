const witcat_more_mouse_picture = "data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSI0NzkuMzg5MDciIGhlaWdodD0iMzU5LjU4OTg0IiB2aWV3Qm94PSIwLDAsNDc5LjM4OTA3LDM1OS41ODk4NCI+PGRlZnM+PGxpbmVhckdyYWRpZW50IHgxPSIyNDAuMDAwMDMiIHkxPSIwLjM2NDIxIiB4Mj0iMjQwLjAwMDAzIiB5Mj0iMzU5LjYzNTgzIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgaWQ9ImNvbG9yLTEiPjxzdG9wIG9mZnNldD0iMCIgc3RvcC1jb2xvcj0iIzhlYWNlMSIvPjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzg5YTdkYSIvPjwvbGluZWFyR3JhZGllbnQ+PGxpbmVhckdyYWRpZW50IHgxPSIyNDYuNzM1MTkiIHkxPSIxMTguMDc2NSIgeDI9IjI0OC4yNzY2OCIgeTI9IjIyMC45OTIxNCIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIGlkPSJjb2xvci0yIj48c3RvcCBvZmZzZXQ9IjAiIHN0b3AtY29sb3I9IiNmZmZmZmYiLz48c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiNlNWVhZjMiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC4zMDU0OSwtMC4zNjQyMSkiPjxnIGRhdGEtcGFwZXItZGF0YT0ieyZxdW90O2lzUGFpbnRpbmdMYXllciZxdW90Ozp0cnVlfSIgZmlsbC1ydWxlPSJub256ZXJvIiBzdHJva2Utd2lkdGg9IjAiIHN0cm9rZS1saW5lam9pbj0ibWl0ZXIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgc3Ryb2tlLWRhc2hhcnJheT0iIiBzdHJva2UtZGFzaG9mZnNldD0iMCIgc3R5bGU9Im1peC1ibGVuZC1tb2RlOiBub3JtYWwiPjxwYXRoIGQ9Ik0wLjMwNTQ5LDM1OS42MzU4M3YtMzU5LjI3MTYyaDQ3OS4zODkwN3YzNTkuMjcxNjJ6IiBmaWxsPSJ1cmwoI2NvbG9yLTEpIiBzdHJva2U9Im5vbmUiIHN0cm9rZS1saW5lY2FwPSJidXR0Ii8+PHBhdGggZD0iTTIwMC45OTA5NiwzNTkuMzM3MDlsMTAuMjI3NzYsLTI0MC4xNDk0OGwxOTMuMDc4NTQsMjQwLjc2NjQ0eiIgZmlsbD0iIzcyOGJiNSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48cGF0aCBkPSJNMjQ3LjA3OTk5LDIyMS4wMTAwNmwtMTIuNDI0LC0zMC4zMzY0M2wtMjAuMDM5MDcsMjAuNjQ4NWwtMS4zODkxNCwtOTIuNzQzNzNsNjguMDE4NTksNjYuMDExMDZsLTI5LjMxODk4LDAuNDM5MTVsMTEuMDk3NTIsMjkuNjk3NDN6IiBmaWxsPSJ1cmwoI2NvbG9yLTIpIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjwvZz48L2c+PC9zdmc+PCEtLXJvdGF0aW9uQ2VudGVyOjIzOS42OTQ1MDYzMjc4NzM5OjE3OS42MzU3OTEwMDI3Mjk3Ny0tPg==";

const witcat_more_mouse_icon = "data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSIxNzcuMDg4NTUiIGhlaWdodD0iMTc3LjA4ODU1IiB2aWV3Qm94PSIwLDAsMTc3LjA4ODU1LDE3Ny4wODg1NSI+PGRlZnM+PGxpbmVhckdyYWRpZW50IHgxPSIyNDcuMDc3MyIgeTE9IjExOS4xNDIzMSIgeDI9IjI0Ny4wNzczIiB5Mj0iMjIyLjA2OTQ4IiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgaWQ9ImNvbG9yLTEiPjxzdG9wIG9mZnNldD0iMCIgc3RvcC1jb2xvcj0iI2ZmZmZmZiIvPjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iI2U1ZWFmMyIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0xNTEuNDU1NzYsLTkxLjQ1NTc0KSI+PGcgZGF0YS1wYXBlci1kYXRhPSJ7JnF1b3Q7aXNQYWludGluZ0xheWVyJnF1b3Q7OnRydWV9IiBmaWxsLXJ1bGU9Im5vbnplcm8iIHN0cm9rZS13aWR0aD0iMCIgc3Ryb2tlLWxpbmVqb2luPSJtaXRlciIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBzdHJva2UtZGFzaGFycmF5PSIiIHN0cm9rZS1kYXNob2Zmc2V0PSIwIiBzdHlsZT0ibWl4LWJsZW5kLW1vZGU6IG5vcm1hbCI+PHBhdGggZD0iTTE1MS40NTU3NiwyNjguNTQ0Mjl2LTE3Ny4wODg1NWgxNzcuMDg4NTV2MTc3LjA4ODU1eiIgZmlsbD0iIzhlYWNlMSIgc3Ryb2tlPSJub25lIiBzdHJva2UtbGluZWNhcD0iYnV0dCIvPjxwYXRoIGQ9Ik0yMzguMjAwNywyNDAuODU3NjlsLTEwLjQ4NDQxLC0zNS4xNjgwMmwtMjEuMzAyNDQsMjEuOTAwNjJsNC40Njc1OCwtMTA0Ljg5OTUxbDYzLjcxNjM3LDc5LjQ1MzQ5bC0yOS4yODgyNCwtMS41OTkxMmw5LjIwMDkxLDM0LjM1MTE1eiIgZmlsbD0iIzcyOGJiNSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48cGF0aCBkPSJNMjQ1Ljg4MDQ3LDIyMi4wNjk0OGwtMTEuOTY4MjcsLTMwLjUxOTFsLTIwLjM0NjA3LDIwLjM0NjA3di05Mi43NTQxM2w2Ny4wMjIzNCw2Ny4wMjIzNGgtMjkuMzIyMjdsMTAuNjUxNTEsMjkuODYwM3oiIGZpbGw9InVybCgjY29sb3ItMSkiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PC9nPjwvZz48L3N2Zz48IS0tcm90YXRpb25DZW50ZXI6ODguNTQ0MjQ0OTk5OTk5OTk6ODguNTQ0MjU1LS0+";

const witcat_more_mouse_extensionId = "WitCatMouse";

/** @typedef {string|number} SCarg æ¥è‡ªScratchåœ†å½¢æ¡†çš„å‚æ•°ï¼Œè™½ç„¶è¿™ä¸ªæ¡†å¯èƒ½åªèƒ½è¾“å…¥æ•°å­—ï¼Œä½†æ˜¯å¯ä»¥æ”¾å…¥å˜é‡ï¼Œå› æ­¤æœ‰å¯èƒ½è·å¾—æ•°å­—å’Œæ–‡æœ¬ï¼Œéœ€è¦åŒæ—¶å¤„ç† */

class WitCatMouse {
	constructor(runtime) {
		/**
		 * é¼ æ ‡é”®æ˜¯å¦æŒ‰ä¸‹
		 * @type {("up"|"down")[]}
		 */
		this.button = ["up", "up", "up", "up", "up"];

		/**
		 * é¼ æ ‡xç§»åŠ¨é€Ÿåº¦
		 */
		this.xMouse = 0;

		/**
		 * é¼ æ ‡yç§»åŠ¨é€Ÿåº¦
		 */
		this.yMouse = 0;

		/**
		 * é¼ æ ‡æ»šè½®é€Ÿåº¦
		 */
		this.MouseWheel = 0;

		/**
		 * é¼ æ ‡é€Ÿåº¦é‡ç½®è®¡æ—¶å™¨
		 * @type {null|number}
		 */
		this.timer = null;

		/**
		 * æ‰‹æŒ‡åˆ—è¡¨
		 * @type {{identifier: number|"mouse", clientX: number, clientY: number}[]}
		 */
		this.touch = [];

		/**
		 * ç‚¹å‡»äº‹ä»¶è®¡æ—¶å™¨
		 * @type {false|number}
		 */
		this.click = false;

		/**
		 * åŒå‡»äº‹ä»¶è®¡æ—¶å™¨
		 * @type {false|number}
		 */
		this.dclick = false;

		/**
		 * é¼ æ ‡æŒ‰ä¸‹è®¡æ—¶å™¨(è®°å½•æŒ‰ä¸‹é¼ æ ‡çš„æ—¶åˆ»)
		 * @type {(""|number)[]}
		 */
		this.mousetdlist = ["", "", "", "", ""];

		/**
		 * Scratch æ‰€ä½¿ç”¨çš„ canvasï¼Œè·å–ä¸åˆ°è¿”å› null
		 * @return {HTMLCanvasElement | null}
		 */
		this.canvas = () => {
			try {
				const canvas = runtime.renderer.canvas;
				if (canvas instanceof HTMLCanvasElement) {
					return canvas;
				} else {
					return null;
				}
			} catch (err) {
				return null;
			}
		};

		if (this.canvas() === null) {
			alert("å½“å‰é¡µé¢ä¸æ”¯æŒå¤šæŒ‡è§¦æ§/å…¨å±ï¼Œè¯·å‰å¾€ä½œå“è¯¦æƒ…é¡µä½“éªŒå®Œæ•´ä½œå“ï¼");
			// æ³¨æ„ï¼šåœ¨æç¤ºä¹‹åï¼Œæ‰©å±•ä»ç„¶åœ¨è¿è¡Œã€‚éœ€è¦åœ¨åé¢å¼•ç”¨ Canvas çš„éƒ¨åˆ†è¿›è¡Œåˆ¤æ–­ã€‚
		}
		this._addevent();

		this.runtime = runtime;
		this._formatMessage = runtime.getFormatMessage({
			"zh-cn": {
				"WitCatMouse.name": "[beta]ç™½çŒ«çš„é«˜çº§é¼ æ ‡",
				"WitCatMouse.name.1": "é«˜çº§é¼ æ ‡",
				"WitCatMouse.name.2": "å¤šæŒ‡è§¦æ§",
				"WitCatMouse.set": "[set]å³é”®èœå•",
				"WitCatMouse.set.1": "å¯ç”¨",
				"WitCatMouse.set.2": "ç¦ç”¨",
				"WitCatMouse.when": "é¼ æ ‡[key]è¢«æŒ‰ä¸‹",
				"WitCatMouse.key.1": "å·¦é”®",
				"WitCatMouse.key.2": "ä¸­é”®",
				"WitCatMouse.key.3": "å³é”®",
				"WitCatMouse.key.4": "å‰ä¾§é”®",
				"WitCatMouse.key.5": "åä¾§é”®",
				"WitCatMouse.mouseuse": "[mouseuse]é¼ æ ‡",
				"WitCatMouse.mouseuse.1": "é”å®š",
				"WitCatMouse.mouseuse.2": "é‡Šæ”¾",
				"WitCatMouse.acceleration": "é¼ æ ‡[way]é€Ÿåº¦",// é€Ÿåº¦å’ŒåŠ é€Ÿåº¦çš„åŒºåˆ«
				"WitCatMouse.way.1": "X",
				"WitCatMouse.way.2": "Y",
				"WitCatTouch.down": "æŒ‰ä¸‹çš„æ‰‹æŒ‡æ•°é‡",
				"WitCatTouch.num": "ç¬¬[num]ä¸ªæ‰‹æŒ‡çš„[type]",
				"WitCatTouch.type.1": "X",
				"WitCatTouch.type.2": "Y",
				"WitCatTouch.type.3": "ID",
				"WitCatMouse.fill": "[set]æ²‰æµ¸å¼å…¨å±",
				"WitCatMouse.fillask.1": "ä½œå“è¯·æ±‚æ²‰æµ¸å¼å…¨å±ï¼Œæ˜¯å¦åŒæ„ï¼Ÿ\n",
				"WitCatMouse.fillask.2": "/3æ¬¡è¿ç»­æ‹’ç»åå°†ä¸å†æç¤º\næ‚¨ä»å¯ä»¥ä½¿ç”¨ ctrl+shift+alt åˆ‡æ¢æ²‰æµ¸å¼å…¨å±çŠ¶æ€",
				"WitCatMouse.setfill": "âš ï¸(å±)è®¾ç½®åˆ†è¾¨ç‡é«˜è®¾ä¸º[num]",
				"WitCatMouse.resolution": "å½“å‰åˆ†è¾¨ç‡é«˜",
				"WitCatMouse.cantouch": "è®¾å¤‡æ”¯æŒ[type]?",
				"WitCatMouse.types.1": "è§¦å±",
				"WitCatMouse.types.2": "é¼ æ ‡",
				"WitCatMouse.IsMobile": "ç§»åŠ¨è®¾å¤‡?",
				"WitCatMouse.cursor": "æ›´æ”¹é¼ æ ‡çš„æ ·å¼ä¸º[cursor]",
				"WitCatMouse.cursor.1": "é»˜è®¤",
				"WitCatMouse.cursor.2": "æ–‡æœ¬",
				"WitCatMouse.cursor.3": "åå­—ç§»åŠ¨",
				"WitCatMouse.cursor.4": "ä¸Šä¸‹ç§»åŠ¨",
				"WitCatMouse.cursor.5": "å·¦å³ç§»åŠ¨",
				"WitCatMouse.cursor.6": "ç¦æ­¢",
				"WitCatMouse.cursor.7": "æ‰‹æŒ‡",
				"WitCatMouse.cursor.8": "åŠ è½½",
				"WitCatMouse.cursor.9": "ç­‰å¾…",
				"WitCatMouse.cursor.10": "å¸®åŠ©",
				"WitCatMouse.cursor.11": "ç«–å‘æ–‡æœ¬",
				"WitCatMouse.cursor.12": "åå­—å‡†æ˜Ÿ",
				"WitCatMouse.cursorurl": "æ›´æ”¹é¼ æ ‡çš„æ ·å¼ä¸ºX[x]Y[y]data url[text]",
				"WitCatMouse.url": "ä¸Šä¼ icoå¹¶è·å¾—data url",
				"WitCatMouse.click": "ç‚¹å‡»",
				"WitCatMouse.dclick": "åŒå‡»",
				"WitCatMouse.mouse": "é¼ æ ‡è¢«[way]?",
				"WitCatMouse.mousetd": "å½“é¼ æ ‡[key]æŒ‰ä½[time]ç§’",
				"WitCatMouse.mouset": "é¼ æ ‡[key]æŒ‰ä¸‹æ—¶é•¿(ç§’)",
				"WitCatMouse.docs": "ğŸ“–æ‹“å±•æ•™ç¨‹",
				"WitCatMouse.mousewheel": "é¼ æ ‡æ»šè½®é€Ÿåº¦",
			},
			en: {
				"WitCatMouse.name": "[beta]WitCatâ€™s Mouse",
				"WitCatMouse.name.1": "more mouse",
				"WitCatMouse.name.2": "more touch",
				"WitCatMouse.set": "[set]right-click menu",
				"WitCatMouse.set.1": "Enable",
				"WitCatMouse.set.2": "Disable",
				"WitCatMouse.when": "mouse[key]down?",
				"WitCatMouse.key.1": "left button",
				"WitCatMouse.key.2": "middle button",
				"WitCatMouse.key.3": "right button",
				"WitCatMouse.key.4": "first side button",
				"WitCatMouse.key.5": "second side button",
				"WitCatMouse.mouseuse": "[mouseuse]mouse",
				"WitCatMouse.mouseuse.1": "Lock",
				"WitCatMouse.mouseuse.2": "Release",
				"WitCatMouse.acceleration": "mouse[way]speed",
				"WitCatMouse.way.1": "X",
				"WitCatMouse.way.2": "Y",
				"WitCatTouch.name": "Touch",
				"WitCatTouch.down": "Finger count",
				"WitCatTouch.num": "[type]of finger[num]",
				"WitCatTouch.type.1": "X",
				"WitCatTouch.type.2": "Y",
				"WitCatTouch.type.3": "ID",
				"WitCatMouse.fill": "[set]immersive full-screen",
				"WitCatMouse.fillask.1": "The project requests to turn on immersive full-screen, agree or not?\nWill stop asking if you keep on to reject for ",
				"WitCatMouse.fillask.2": "/3 times\nYou can also use Ctrl+Shift+Alt to toggle immersive full-screen later.",
				"WitCatMouse.setfill": "âš ï¸(danger)Set resolution height to[num]",
				"WitCatMouse.resolution": "Current high resolution",
				"WitCatMouse.cantouch": "Device support[type]?",
				"WitCatMouse.types.1": "touch screen",
				"WitCatMouse.types.2": "mouse",
				"WitCatMouse.IsMobile": "Mobile device?",
				"WitCatMouse.cursor": "Change cursor style to[cursor]",
				"WitCatMouse.cursor.1": "default",
				"WitCatMouse.cursor.2": "text",
				"WitCatMouse.cursor.3": "cross move",
				"WitCatMouse.cursor.4": "move up and down",
				"WitCatMouse.cursor.5": "move left and right",
				"WitCatMouse.cursor.6": "not allowed",
				"WitCatMouse.cursor.7": "pointer",
				"WitCatMouse.cursor.8": "progress",
				"WitCatMouse.cursor.9": "wait",
				"WitCatMouse.cursor.10": "help",
				"WitCatMouse.cursor.11": "vertical text",
				"WitCatMouse.cursor.12": "crosshair",
				"WitCatMouse.cursorurl": "Change the style of the mouse to X[x]Y[y]base64[text]",
				"WitCatMouse.url": "upload ico and get base64",
				"WitCatMouse.click": "click",
				"WitCatMouse.dclick": "double-click",
				"WitCatMouse.mouse": "mouse[way]?",
				"WitCatMouse.mousetd": "When mouse[key]pressed[time]seconds",
				"WitCatMouse.mouset": "mouse[key]hold time(sec)",
				"WitCatMouse.docs": "ğŸ“–Tutorials",
				"WitCatInput.mousewheel": "mouse wheel speed",
			}
		})
	}

	/**
	 * ç¿»è¯‘
	 * @param {string} id
	 * @returns {string}
	 */
	formatMessage(id) {
		return this._formatMessage({
			id,
			default: id,
			description: id
		});
	}

	getInfo() {
		return {
			id: witcat_more_mouse_extensionId, // æ‹“å±•id
			name: this.formatMessage("WitCatMouse.name"), // æ‹“å±•å
			blockIconURI: witcat_more_mouse_icon,
			menuIconURI: witcat_more_mouse_icon,
			color1: "#8eace1",
			color2: "#86a2d4",
			blocks: [
				{
					blockType: "button",
					text: this.formatMessage('WitCatMouse.docs'),
					onClick: this.docs,
				},
				{
					opcode: 'setfill',
					blockType: "command",
					text: this.formatMessage("WitCatMouse.setfill"),
					hideFromPalette: true,
					arguments: {
						num: {
							type: "number",
							defaultValue: "360",
						},
					}
				},
				{
					opcode: 'fill',
					blockType: "command",
					text: this.formatMessage("WitCatMouse.fill"),
					hideFromPalette: true,
					arguments: {
						set: {
							type: "bool",
							menu: "set",
						},
					}
				},
				{
					opcode: 'resolution',
					blockType: "reporter",
					text: this.formatMessage("WitCatMouse.resolution"),
					arguments: {}
				},
				"---" + this.formatMessage("WitCatMouse.name.1"),
				{
					opcode: 'set',
					blockType: "command",
					text: this.formatMessage("WitCatMouse.set"),
					arguments: {
						set: {
							type: "bool",
							menu: "set",
						},
					}
				},
				{
					opcode: "when",
					blockType: "Boolean",
					text: this.formatMessage("WitCatMouse.when"),
					arguments: {
						key: {
							type: "string",
							menu: "key",
						},
					},
				},
				{
					opcode: "mouses",
					blockType: "Boolean",
					text: this.formatMessage("WitCatMouse.mouse"),
					arguments: {
						way: {
							type: "string",
							menu: "ways",
						},
					},
				},
				{
					opcode: "mousewheel",
					blockType: "reporter",
					text: this.formatMessage("WitCatMouse.mousewheel"),
					arguments: {},
				},
				{
					opcode: "mouse",
					blockType: "hat",
					text: this.formatMessage("WitCatMouse.mouse"),
					arguments: {
						way: {
							type: "string",
							menu: "ways",
						},
					},
				},
				{
					opcode: "mousetd",
					blockType: "Boolean",
					text: this.formatMessage("WitCatMouse.mousetd"),
					arguments: {
						key: {
							type: "number",
							menu: "key",
						},
						time: {
							type: "number",
							defaultValue: "1",
						},
					},
				},
				{
					opcode: "mousetds",
					blockType: "hat",
					text: this.formatMessage("WitCatMouse.mousetd"),
					arguments: {
						key: {
							type: "number",
							menu: "key",
						},
						time: {
							type: "number",
							defaultValue: "1",
						},
					},
				},
				{
					opcode: "mouset",
					blockType: "reporter",
					text: this.formatMessage("WitCatMouse.mouset"),
					arguments: {
						key: {
							type: "number",
							menu: "key",
						},
					},
				},
				{
					blockType: "button",
					text: this.formatMessage('WitCatMouse.url'),
					// è¿™é‡Œçš„ bind å¿…é¡»ï¼Œå› ä¸º this.url é‡Œé¢å¼•ç”¨äº† this
					onClick: this.url.bind(this),
				},
				{
					opcode: "cursor",
					blockType: "command",
					text: this.formatMessage("WitCatMouse.cursor"),
					arguments: {
						cursor: {
							type: "string",
							menu: "cursor",
						},
					},
				},
				{
					opcode: "cursorurl",
					blockType: "command",
					text: this.formatMessage("WitCatMouse.cursorurl"),
					arguments: {
						x: {
							type: "string",
							defaultValue: "0",
						},
						y: {
							type: "string",
							defaultValue: "0",
						},
						text: {
							type: "string",
							defaultValue: "base64:ico",
						},
					},
				},
				{
					opcode: "mouseuse",
					blockType: "command",
					text: this.formatMessage("WitCatMouse.mouseuse"),
					arguments: {
						mouseuse: {
							type: "string",
							menu: "mouseuse",
						},
					},
				},
				{
					opcode: "acceleration",
					blockType: "reporter",
					text: this.formatMessage("WitCatMouse.acceleration"),
					arguments: {
						way: {
							type: "string",
							menu: "way",
						},
					},
				},
				"---" + this.formatMessage("WitCatMouse.name.2"),
				{
					opcode: 'down',
					blockType: "reporter",
					text: this.formatMessage("WitCatTouch.down"),
					arguments: {}
				},
				{
					opcode: "num",
					blockType: "reporter",
					text: this.formatMessage("WitCatTouch.num"),
					arguments: {
						num: {
							type: "number",
							defaultValue: "1",
						},
						type: {
							type: "string",
							menu: "type",
						},
					},
				},
				{
					opcode: "cantouch",
					blockType: "Boolean",
					text: this.formatMessage("WitCatMouse.cantouch"),
					arguments: {
						type: {
							type: "string",
							menu: "types",
						},
					},
				},
				{
					opcode: "IsMobile",
					blockType: "Boolean",
					text: this.formatMessage("WitCatMouse.IsMobile"),
					arguments: {},
				},
			],
			menus: {
				key: [
					{
						text: this.formatMessage('WitCatMouse.key.1'),
						value: '0'
					},
					{
						text: this.formatMessage('WitCatMouse.key.2'),
						value: '1'
					},
					{
						text: this.formatMessage('WitCatMouse.key.3'),
						value: '2'
					},
					{
						text: this.formatMessage('WitCatMouse.key.4'),
						value: '3'
					},
					{
						text: this.formatMessage('WitCatMouse.key.5'),
						value: '4'
					},
				],
				cursor: {
					acceptReporters: true,
					items: [
						{
							text: this.formatMessage('WitCatMouse.cursor.1'),
							value: 'default'
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.2'),
							value: 'text'
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.3'),
							value: 'move'
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.4'),
							value: 'n-resize'
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.5'),
							value: 'e-resize'
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.6'),
							value: 'not-allowed'
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.7'),
							value: 'pointer'
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.8'),
							value: 'progress'
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.9'),
							value: 'wait'
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.10'),
							value: 'help'
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.11'),
							value: 'vertical-text'
						},
						{
							text: this.formatMessage('WitCatMouse.cursor.12'),
							value: 'crosshair'
						},
					],
				},
				set: [
					{
						text: this.formatMessage('WitCatMouse.set.1'),
						value: "true"
					},
					{
						text: this.formatMessage('WitCatMouse.set.2'),
						value: "false"
					},
				],
				way: [
					{
						text: this.formatMessage('WitCatMouse.way.1'),
						value: "x"
					},
					{
						text: this.formatMessage('WitCatMouse.way.2'),
						value: "y"
					},
				],
				ways: [
					{
						text: this.formatMessage('WitCatMouse.click'),
						value: "click"
					},
					{
						text: this.formatMessage('WitCatMouse.dclick'),
						value: "dclick"
					},
				],
				type: [
					{
						text: this.formatMessage('WitCatTouch.type.1'),
						value: "x"
					},
					{
						text: this.formatMessage('WitCatTouch.type.2'),
						value: "y"
					},
					{
						text: this.formatMessage('WitCatTouch.type.3'),
						value: "ID"
					},
				],
				types: [
					{
						text: this.formatMessage('WitCatMouse.types.1'),
						value: "ontouchstart"
					},
					{
						text: this.formatMessage('WitCatMouse.types.2'),
						value: "onmousedown"
					},
				],
				mouseuse: [
					{
						text: this.formatMessage('WitCatMouse.mouseuse.1'),
						value: "lock"
					},
					{
						text: this.formatMessage('WitCatMouse.mouseuse.2'),
						value: "release"
					},
				],
			}
		};
	}

	/**
	 * å¯ç”¨å³é”®èœå•ï¼Ÿ
	 * @param {object} args
	 * @param {SCarg} args.set
	 */
	set(args) {
		const canvas = this.canvas();
		if (canvas === null) {
			return;
		}
		// åœ¨æŠŠè‡ªå·±çš„æ–¹æ³•è®¾ä¸ºç»™å…¶ä»–äº‹ä»¶/å‡½æ•°çš„å›è°ƒæ—¶åŠ ä¸Š bind(this) æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œ
		// ç¡®ä¿å›è°ƒå‡½æ•°è§¦å‘æ—¶ï¼Œé‡Œé¢çš„ this æŒ‡å‘è‡ªå·±ã€‚
		// ä¸è¿‡å›è°ƒå‡½æ•°é‡Œé¢æ²¡æœ‰ç”¨åˆ° thisï¼Œæ‰€ä»¥æ˜¯å¦æœ‰è¿™ä¸ª bind æ²¡æœ‰åŒºåˆ«ã€‚
		// å¦‚æœåŠ ä¸Šäº† bindï¼Œå› ä¸ºæ¯æ¬¡ bind() éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°å‡½æ•°ï¼Œ
		// removeEventListener çš„æ—¶å€™å°±ä¼šå› ä¸ºå‡½æ•°ä¸ä¸€è‡´å¯¼è‡´ remove ä¸æ‰ï¼Œ
		// éœ€è¦æå‰æŠŠ bind è¿‡çš„å‡½æ•°è®¾ä¸ºæŸç±»å†…å˜é‡ã€‚
		if (args.set === "false") {
			canvas.addEventListener("contextmenu", this._nocontextmenu);
		} else {
			canvas.removeEventListener("contextmenu", this._nocontextmenu);
		}
	}

	/**
	 * ç¦ç”¨å³é”®èœå•ç”¨çš„äº‹ä»¶æ•è·å‡½æ•°
	 * @param {Event} event
	 */
	_nocontextmenu(event) {
		// é˜»æ­¢å³é”®èœå•
		event.preventDefault();
	}

	/**
	 * æŒ‰ä¸‹åˆ¤æ–­
	 * @param {object} args
	 * @param {SCarg} args.key
	 */
	when(args) {
		return this.button[Number(args.key)] === "down";
	}

	/**
	 * æ§åˆ¶é¼ æ ‡
	 * @param {object} args
	 * @param {SCarg} args.mouseuse
	 */
	mouseuse(args) {
		if (args.mouseuse === "release") {
			document.exitPointerLock();
		}
		else {
			document.body.requestPointerLock();
		}
	}

	/**
	 * é¼ æ ‡ç§»åŠ¨é‡
	 * @param {object} args
	 * @param {SCarg} args.way
	 * @returns {number}
	 */
	acceleration(args) {
		if (args.way === "x") {
			return this.xMouse;
		}
		else {
			return -this.yMouse;
		}
	}

	/**
	 * æ‰‹æŒ‡æ•°é‡
	 * @returns {number}
	 */
	down() {
		return this.touch.length;
	}

	/**
	 * åæ ‡
	 * @param {object} args
	 * @param {SCarg} args.num æ‰‹æŒ‡ç¼–å·
	 * @param {SCarg} args.type æ•°æ®ç±»å‹ "x"|"y"|"identifier"
	 * @returns {number|string}
	 */
	num(args) {
		const canvas = this.canvas();
		if (canvas === null) {
			return 0;
		}
		const touch1 = this.touch[Number(args.num) - 1];
		if (touch1 !== undefined) {
			if (args.type === "x") {
				return this.runtime.stageWidth * ((touch1.clientX - canvas.getBoundingClientRect().left) / canvas.offsetWidth);
			}
			else if (args.type === "y") {
				return this.runtime.stageHeight * ((touch1.clientY - canvas.getBoundingClientRect().top) / canvas.offsetHeight);
			}
			else {
				return touch1.identifier;
			}
		}
		else {
			return 0;
		}
	}

	/**
	 * å…¨å±
	 * @deprecated
	 */
	fill() {
		console.warn("å…¨å±å› æµè§ˆå™¨å…¼å®¹é—®é¢˜å·²ä¸‹çº¿ï¼Œåœ¨æœªæ¥ä¿®å¤åå°†ä¼šé‡æ–°ä¸Šçº¿\nFull screen has been taken offline due to browser compatibility issues. It will be back online after a future fix");
	}

	/**
	 * è®¾ç½®åˆ†è¾¨ç‡
	 * @deprecated
	 */
	setfill() {
		console.warn("å…¨å±å› æµè§ˆå™¨å…¼å®¹é—®é¢˜å·²ä¸‹çº¿ï¼Œåœ¨æœªæ¥ä¿®å¤åå°†ä¼šé‡æ–°ä¸Šçº¿\nFull screen has been taken offline due to browser compatibility issues. It will be back online after a future fix");
	}

	/**
	 * å½“å‰åˆ†è¾¨ç‡
	 * @returns {number}
	 */
	resolution() {
		const canvas = this.canvas();
		if (canvas === null) {
			return 0;
		}
		return canvas.height;
	}

	/**
	 * è®¾å¤‡æ˜¯å¦æ”¯æŒè§¦å±/é¼ æ ‡
	 * @param {object} args
	 * @param {SCarg} args.type
	 * @returns {boolean}
	 */
	cantouch(args) {
		return (args.type in document.documentElement);
	}

	/**
	 * æ˜¯å¦æ˜¯æ‰‹æœº
	 * @returns {boolean}
	 */
	IsMobile() {
		return /Android|iPhone|iPad|iPod|BlackBerry|webOS|Windows Phone|SymbianOS|IEMobile|Opera Mini/i.test(navigator.userAgent);
	}

	/**
	 * è®¾ç½®å…‰æ ‡æ ·å¼
	 * @param {object} args
	 * @param {SCarg} args.cursor æ ·å¼
	 */
	cursor(args) {
		const canvasParent = this.canvas()?.parentNode?.parentNode?.parentNode;
		if (canvasParent === null || canvasParent === undefined) {
			return;
		}
		canvasParent.style.cursor = String(args.cursor);
	}

	/**
	 * è®¾ç½®å…‰æ ‡ä¸ºurl
	 * @param {object} args
	 * @param {SCarg} args.text æ ·å¼
	 * @param {SCarg} args.x xåç§»
	 * @param {SCarg} args.y yåç§»
	 */
	cursorurl(args) {
		const canvasParent = this.canvas()?.parentNode?.parentNode?.parentNode;
		if (canvasParent === null || canvasParent === undefined) {
			return;
		}
		let url = String(args.text);
		const x = Number(args.x);
		const y = Number(args.y);
		// é’ˆå¯¹ url() é‡Œçš„è¯­æ³•ï¼Œè½¬ä¹‰ã€‚
		url = url.replace(/"/g, "%22").replace(/\n/g, "%0D")
			.replace(/\r/g, "%0A").replace(/\0/g, "%00");
		// å®é™…ä¸Š cursorurl å¤„å¯ä»¥ç›´æ¥ä½¿ç”¨ æ­£å¸¸çš„ url å’Œ data urlã€‚
		// ä¸éœ€è¦ç‰¹åœ°è½¬æ¢ã€‚
		canvasParent.style.cursor = `url("${url}") ${x} ${y}, auto`;
	}

	/**
	 * æ‰“å¼€æ–‡ä»¶é€‰æ‹©æ¡†
	 * @param {string} accept æ¥å—çš„æ–‡ä»¶æ‰©å±•å
	 * @param {boolean} multiple æ¥å—å¤šä¸ªæ–‡ä»¶
	 * @return {Promise<File[]>} [å¼‚æ­¥åœ°]è¿”å›é€‰æ‹©åçš„æ–‡ä»¶åˆ—è¡¨input.filesè½¬æ¢æˆçš„æ•°ç»„(å¯èƒ½æ²¡æœ‰æ–‡ä»¶)
	 */
	_inputfileclick(accept, multiple) {
		return new Promise((resolve, reject) => {
			const input = document.createElement("input");
			input.type = "file";
			input.accept = accept;
			input.style.display = "none";
			input.multiple = multiple;
			input.click();
			input.addEventListener("change", () => {
				if (input.files === null) {
					reject(new Error("ä¸åº”è¯¥çœ‹åˆ°è¿™ä¸ª"));
				} else {
					// è¿”å›äº†å…³é”®çš„ input.filesï¼Œè€Œä¸æ˜¯æ•´ä¸ª inputã€‚
					// ä¹‹åå¦‚æœè¦è€ƒè™‘â€œè¯»å–ç´ æåº“æ–‡ä»¶â€ï¼Œâ€œæ‹–åŠ¨å¯¼å…¥æ–‡ä»¶â€ç­‰
					// åªèƒ½è·å¾— Blob/File çš„æƒ…å†µï¼Œå¯ä»¥æ–¹ä¾¿é€‚é…
					// è¿™é‡ŒåŠ  Array.from æ˜¯å› ä¸º input.files æ˜¯ FileListï¼Œ
					// ä¸æ˜¯ File[]ï¼Œä¸€äº›æ•°ç»„æ‹¥æœ‰çš„åŠŸèƒ½å®ƒæ²¡æœ‰ã€‚è™½ç„¶ä¸€èˆ¬æƒ…å†µä¸‹
					// ä¸ä¼šæ³¨æ„åˆ°åŒºåˆ«ï¼Œä½†æ˜¯ç±»å‹æ£€æŸ¥ä¼šæŠŠè¿™ç§æƒ…å†µæŸ¥å‡ºæ¥ã€‚
					resolve(Array.from(input.files));
				}
			}, { once: true }); // åªè§¦å‘ä¸€æ¬¡
			window.addEventListener("focus", () => {
				setTimeout(() => {
					if (input.files === null) {
						reject(new Error("ä¸åº”è¯¥çœ‹åˆ°è¿™ä¸ª"));
					} else {
						resolve(Array.from(input.files));
					}
				}, 1000);
			}, { once: true }); // åªè§¦å‘ä¸€æ¬¡
		});
	}

	/**
	 * è¯»å–æ–‡ä»¶
	 * @param {File|Blob} file File æˆ–è€… Blob
	 * @param {"arraybuffer"|"dataurl"|"text"} mode è¯»å–æ¨¡å¼
	 * @return {Promise<string|ArrayBuffer|null>} [å¼‚æ­¥åœ°]è¿”å›è¯»å–åçš„å†…å®¹
	 */
	_readerasync(file, mode) {
		return new Promise((resolve, reject) => {
			const reader = new FileReader();
			reader.onload = () => {
				resolve(reader.result);
			};
			reader.onerror = (e) => {
				reject(e);
			};
			switch (mode) {
				case "arraybuffer":
					reader.readAsArrayBuffer(file);
					break;
				case "dataurl":
					reader.readAsDataURL(file);
					break;
				case "text":
					reader.readAsText(file);
					break;
				default:
					reject(new Error("mode é”™è¯¯: åº”è¯¥æ˜¯ arraybuffer, dataurl æˆ–è€… text"));
					return;
			}
		});
	}

	/**
	 * æ‰“å¼€icoæ–‡ä»¶
	 */
	async url() {
		const file = (await this._inputfileclick(".ico", false))[0];
		if (file !== undefined) {
			// åŠ ä¸€ä¸ªæ‰©å±•ååˆ¤æ–­ï¼Ÿ
			const dataurl = String(await this._readerasync(file, "dataurl"));
			prompt("è¯·å¤åˆ¶ä»¥ä¸‹ä»£ç ï¼š", dataurl);
		}
	}

	/**
	 * æ‰“å¼€æ•™ç¨‹
	 */
	docs() {
		let a = document.createElement('a');
		a.href = "https://www.ccw.site/post/c36aa805-b29d-48da-aba1-468a6cf80bfa";
		a.rel = "noopener noreferrer";
		a.target = "_blank";
		a.click();
	}

	/**
	 * é¼ æ ‡ç‚¹å‡»/åŒå‡»
	 * @param {object} args
	 * @param {SCarg} args.way ç‚¹å‡»/åŒå‡»
	 * @returns {boolean}
	 */
	mouse(args) {
		if (args.way === "click") {
			return this.click !== false;
		}
		if (args.way === "dclick") {
			return this.dclick !== false;
		}
		return false;
	}

	/**
	 * é¼ æ ‡æ»šè½®é€Ÿåº¦
	 * @returns {number}
	 */
	mousewheel() {
		return this.MouseWheel;
	}

	/**
	 * é¼ æ ‡ç‚¹å‡»/åŒå‡»(å¸½å­ç§¯æœ¨)
	 * @param {object} args
	 * @param {SCarg} args.way ç‚¹å‡»/åŒå‡»
	 * @returns {boolean}
	 */
	mouses(args) {
		return this.mouse(args);
	}

	/**
	 * åˆ¤æ–­é¼ æ ‡é”®æŒ‰ä¸‹æ—¶é•¿
	 * @param {object} args
	 * @param {SCarg} args.key æŒ‰é”®ç¼–å·
	 * @param {SCarg} args.time æŒ‰é”®æ—¶é•¿
	 * @returns {boolean}
	 */
	mousetd(args) {
		const mousetdkey = this.mousetdlist[Number(args.key)];
		if (mousetdkey !== undefined && mousetdkey != "") {
			let time = Date.now() - (Number(args.time) * 1000 + mousetdkey);
			if (-50 <= time && time <= 50) {
				return true;
			}
		}
		return false;
	}

	/**
	 * åˆ¤æ–­é¼ æ ‡é”®æŒ‰ä¸‹æ—¶é•¿(å¸½å­ç§¯æœ¨)
	 * @param {object} args
	 * @param {SCarg} args.key æŒ‰é”®ç¼–å·
	 * @param {SCarg} args.time æŒ‰é”®æ—¶é•¿
	 * @returns {boolean}
	 */
	mousetds(args) {
		return this.mousetd(args);
	}

	/**
	 * é¼ æ ‡è¢«æŒ‰ä¸‹çš„æ—¶é—´
	 * @param {object} args
	 * @param {SCarg} args.key æŒ‰é”®ç¼–å·
	 * @returns {number}
	 */
	mouset(args) {
		const mousetdkey = this.mousetdlist[Number(args.key)];
		if (mousetdkey !== undefined && mousetdkey != "") {
			return (Date.now() - mousetdkey) / 1000;
		}
		return 0;
	}

	/**
	 * å¤åˆ¶è§¦æ‘¸ç‚¹æ•°
	 * @param {TouchList} touches
	 */
	_copytouch(touches) {
		this.touch = Array.from(touches).map((touch) => {
			return {
				clientX: touch.clientX,
				clientY: touch.clientY,
				identifier: touch.identifier
			}
		});
	}

	/** æ·»åŠ äº‹ä»¶è§¦å‘å™¨ */
	_addevent() {
		const canvas = this.canvas();
		if (canvas === null) {
			return;
		}
		//é¼ æ ‡
		canvas.addEventListener('mousedown', e => {
			this.button[e.button] = "down";
			this.mousetdlist[e.button] = Date.now();
			if (this.button[0] === "down") {
				this.touch = [{
					clientX: e.clientX,
					clientY: e.clientY,
					identifier: "mouse"
				}];
			}
		})
		document.addEventListener('mouseup', e => {
			this.button[e.button] = "up";
			this.mousetdlist[e.button] = "";
			this.touch = [];
		})
		document.addEventListener("mousemove", ev => {
			if (this.button[0] === "down") {
				this.touch = [{
					clientX: ev.clientX,
					clientY: ev.clientY,
					identifier: "mouse"
				}];
			}
			else {
				this.touch = [];
			}
			this.xMouse = ev.movementX; // è·å¾—é¼ æ ‡æŒ‡é’ˆçš„xç§»åŠ¨é‡
			this.yMouse = ev.movementY; // è·å¾—é¼ æ ‡æŒ‡é’ˆçš„yç§»åŠ¨é‡
			if (this.timer !== null) {
				clearTimeout(this.timer);
			}
			this.timer = setTimeout(() => {
				this.xMouse = 0;
				this.yMouse = 0;
			}, 30);
		});
		//å¤šæŒ‡è§¦æ§
		canvas.addEventListener('touchstart', e => {
			// e.targetTouches ä¼šéšç€æ—¶é—´æ”¹å˜ï¼Œå¿…é¡»å¤åˆ¶ä¸€ä»½ã€‚
			this._copytouch(e.targetTouches);
			this.button[0] = "down";
			this.mousetdlist[0] = Date.now();
		})
		canvas.addEventListener('touchmove', e => {
			if (e.targetTouches[0] !== undefined && this.touch[0] !== undefined) {
				this.xMouse = e.targetTouches[0].clientX - this.touch[0].clientX; // è·å¾—æ‰‹æŒ‡çš„xç§»åŠ¨é‡
				this.yMouse = e.targetTouches[0].clientY - this.touch[0].clientY; // è·å¾—æ‰‹æŒ‡çš„yç§»åŠ¨é‡
			}
			if (this.timer !== null) {
				clearTimeout(this.timer);
			}
			this.timer = setTimeout(() => {
				this.xMouse = 0;
				this.yMouse = 0;
			}, 30);
			// e.targetTouches ä¼šéšç€æ—¶é—´æ”¹å˜ï¼Œå¿…é¡»å¤åˆ¶ä¸€ä»½ã€‚
			this._copytouch(e.targetTouches);
		})
		canvas.addEventListener('touchend', e => {
			// e.targetTouches ä¼šéšç€æ—¶é—´æ”¹å˜ï¼Œå¿…é¡»å¤åˆ¶ä¸€ä»½ã€‚
			this._copytouch(e.targetTouches);
			this.mousetdlist[0] = "";
			this.button[0] = "up";
		})
		canvas.addEventListener('click', () => {
			if (this.click !== false) {
				clearTimeout(this.click);
			}
			this.click = setTimeout(() => {
				this.click = false;
			}, 50);
		});
		canvas.addEventListener('dblclick', () => {
			if (this.dclick !== false) {
				clearTimeout(this.dclick);
			}
			this.dclick = setTimeout(() => {
				this.dclick = false;
			}, 50);
		});
		//ç»™é¡µé¢ç»‘å®šæ»‘è½®æ»šåŠ¨äº‹ä»¶
		canvas.addEventListener('wheel', (e) => {
			this.MouseWheel = e.deltaY;
			if (this.timer !== null) {
				clearTimeout(this.timer);
			}
			this.timer = setTimeout(() => {
				this.MouseWheel = 0;
			}, 30);
		}, { capture: true });
	}
}

window.tempExt = {
	Extension: WitCatMouse,
	info: {
		name: "WitCatMouse.name",
		description: "WitCatMouse.descp",
		extensionId: witcat_more_mouse_extensionId,
		iconURL: witcat_more_mouse_picture,
		insetIconURL: witcat_more_mouse_icon,
		featured: true,
		disabled: false,
		collaborator: "ç™½çŒ« @ CCW"
	},
	l10n: {
		"zh-cn": {
			"WitCatMouse.name": "[beta]ç™½çŒ«çš„é«˜çº§é¼ æ ‡",
			"WitCatMouse.descp": "æ›´ç²¾å‡†çš„æ§åˆ¶é¼ æ ‡/è§¦å±/å…¨å±ï¼"
		},
		en: {
			"WitCatMouse.name": "[beta]WitCatâ€™s Mouse",
			"WitCatMouse.descp": "More precise mouse/touch/full screen control!"
		}
	}
};
